<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/blog/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/blog/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/blog/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/blog/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="分布式,">





  <link rel="alternate" href="/blog/atom.xml" title="张鹏的博客" type="application/atom+xml">






<meta name="description" content="大型分布式网站架构  1. 大型分布式网站架构概述 1.1. 大型网站的特点 1.2. 大型网站架构目标 1.3. 大型网站架构模式 1.4. 高性能架构 1.5. 高可用架构 1.6. 可伸缩架构 1.7. 可扩展架构 1.8. 安全架构 1.9. 敏捷性 1.10. 大型架构举例   2. 电商网站架构案例 2.1. 网站初级架构 2.2. 系统容量预估 2.3. 网站架构分析 2.4. 网站">
<meta name="keywords" content="分布式">
<meta property="og:type" content="article">
<meta property="og:title" content="大型分布式网站架构">
<meta property="og:url" content="http://yoursite.com/2018/07/05/programming/java/javaweb/architecture/大型分布式网站架构/index.html">
<meta property="og:site_name" content="张鹏的博客">
<meta property="og:description" content="大型分布式网站架构  1. 大型分布式网站架构概述 1.1. 大型网站的特点 1.2. 大型网站架构目标 1.3. 大型网站架构模式 1.4. 高性能架构 1.5. 高可用架构 1.6. 可伸缩架构 1.7. 可扩展架构 1.8. 安全架构 1.9. 敏捷性 1.10. 大型架构举例   2. 电商网站架构案例 2.1. 网站初级架构 2.2. 系统容量预估 2.3. 网站架构分析 2.4. 网站">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://images2015.cnblogs.com/blog/820332/201511/820332-20151116062211858-1998556963.png">
<meta property="og:image" content="https://images2015.cnblogs.com/blog/820332/201511/820332-20151130071801546-1010554271.png">
<meta property="og:image" content="https://images2015.cnblogs.com/blog/820332/201511/820332-20151130071816093-197013108.png">
<meta property="og:image" content="https://images2015.cnblogs.com/blog/820332/201511/820332-20151130073032968-1952416935.png">
<meta property="og:image" content="https://images2015.cnblogs.com/blog/820332/201511/820332-20151130073047530-940494801.png">
<meta property="og:image" content="https://images2015.cnblogs.com/blog/820332/201511/820332-20151130073058983-1408763899.png">
<meta property="og:image" content="https://images2015.cnblogs.com/blog/820332/201511/820332-20151130073113483-523713370.png">
<meta property="og:image" content="https://images2015.cnblogs.com/blog/820332/201511/820332-20151130073125015-707498377.png">
<meta property="og:image" content="https://images2015.cnblogs.com/blog/820332/201512/820332-20151201062903515-1864482914.png">
<meta property="og:image" content="https://images2015.cnblogs.com/blog/820332/201512/820332-20151201062916952-1233076938.png">
<meta property="og:image" content="https://images2015.cnblogs.com/blog/820332/201512/820332-20151201062938155-1893082140.png">
<meta property="og:image" content="https://images2015.cnblogs.com/blog/820332/201512/820332-20151201062949187-431217543.png">
<meta property="og:updated_time" content="2019-03-06T08:43:46.722Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="大型分布式网站架构">
<meta name="twitter:description" content="大型分布式网站架构  1. 大型分布式网站架构概述 1.1. 大型网站的特点 1.2. 大型网站架构目标 1.3. 大型网站架构模式 1.4. 高性能架构 1.5. 高可用架构 1.6. 可伸缩架构 1.7. 可扩展架构 1.8. 安全架构 1.9. 敏捷性 1.10. 大型架构举例   2. 电商网站架构案例 2.1. 网站初级架构 2.2. 系统容量预估 2.3. 网站架构分析 2.4. 网站">
<meta name="twitter:image" content="https://images2015.cnblogs.com/blog/820332/201511/820332-20151116062211858-1998556963.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/blog/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/07/05/programming/java/javaweb/architecture/大型分布式网站架构/">





  <title>大型分布式网站架构 | 张鹏的博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/blog/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">张鹏的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">大道至简，知易行难</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/blog/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/blog/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/blog/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/blog/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/blog/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/blog/2018/07/05/programming/java/javaweb/architecture/大型分布式网站架构/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhang Peng">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张鹏的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">大型分布式网站架构</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-05T00:00:00+08:00">
                2018-07-05
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/分布式/" itemprop="url" rel="index">
                    <span itemprop="name">分布式</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="大型分布式网站架构"><a href="#大型分布式网站架构" class="headerlink" title="大型分布式网站架构"></a>大型分布式网站架构</h1><!-- TOC depthFrom:2 depthTo:3 -->
<ul>
<li><a href="#1-大型分布式网站架构概述">1. 大型分布式网站架构概述</a><ul>
<li><a href="#11-大型网站的特点">1.1. 大型网站的特点</a></li>
<li><a href="#12-大型网站架构目标">1.2. 大型网站架构目标</a></li>
<li><a href="#13-大型网站架构模式">1.3. 大型网站架构模式</a></li>
<li><a href="#14-高性能架构">1.4. 高性能架构</a></li>
<li><a href="#15-高可用架构">1.5. 高可用架构</a></li>
<li><a href="#16-可伸缩架构">1.6. 可伸缩架构</a></li>
<li><a href="#17-可扩展架构">1.7. 可扩展架构</a></li>
<li><a href="#18-安全架构">1.8. 安全架构</a></li>
<li><a href="#19-敏捷性">1.9. 敏捷性</a></li>
<li><a href="#110-大型架构举例">1.10. 大型架构举例</a></li>
</ul>
</li>
<li><a href="#2-电商网站架构案例">2. 电商网站架构案例</a><ul>
<li><a href="#21-网站初级架构">2.1. 网站初级架构</a></li>
<li><a href="#22-系统容量预估">2.2. 系统容量预估</a></li>
<li><a href="#23-网站架构分析">2.3. 网站架构分析</a></li>
<li><a href="#24-网站架构优化">2.4. 网站架构优化</a></li>
<li><a href="#25-架构总结">2.5. 架构总结</a></li>
</ul>
</li>
<li><a href="#3-资料">3. 资料</a></li>
</ul>
<!-- /TOC -->
<h2 id="1-大型分布式网站架构概述"><a href="#1-大型分布式网站架构概述" class="headerlink" title="1. 大型分布式网站架构概述"></a>1. 大型分布式网站架构概述</h2><h3 id="1-1-大型网站的特点"><a href="#1-1-大型网站的特点" class="headerlink" title="1.1. 大型网站的特点"></a>1.1. 大型网站的特点</h3><ul>
<li>用户多，分布广泛</li>
<li>大流量，高并发</li>
<li>海量数据，服务高可用</li>
<li>安全环境恶劣，易受网络攻击</li>
<li>功能多，变更快，频繁发布</li>
<li>从小到大，渐进发展</li>
<li>以用户为中心</li>
<li>免费服务，付费体验</li>
</ul>
<h3 id="1-2-大型网站架构目标"><a href="#1-2-大型网站架构目标" class="headerlink" title="1.2. 大型网站架构目标"></a>1.2. 大型网站架构目标</h3><ul>
<li>高性能：提供快速的访问体验。</li>
<li>高可用：网站服务一直可以正常访问。</li>
<li>可伸缩：通过硬件增加/减少，提高/降低处理能力。</li>
<li>安全性：提供网站安全访问和数据加密，安全存储等策略。</li>
<li>扩展性：方便的通过新增/移除方式，增加/减少新的功能/模块。</li>
<li>敏捷性：随需应变，快速响应；</li>
</ul>
<h3 id="1-3-大型网站架构模式"><a href="#1-3-大型网站架构模式" class="headerlink" title="1.3. 大型网站架构模式"></a>1.3. 大型网站架构模式</h3><ul>
<li>分层：一般可分为，应用层，服务层，数据层，管理层，分析层；</li>
<li>分割：一般按照业务/模块/功能特点进行划分，比如应用层分为首页，用户中心。</li>
<li>分布式：将应用分开部署（比如多台物理机），通过远程调用协同工作。</li>
<li>集群：一个应用/模块/功能部署多份（如：多台物理机），通过负载均衡共同提供对外访问。</li>
<li>缓存：将数据放在距离应用或用户最近的位置，加快访问速度。</li>
<li>异步：将同步的操作异步化。客户端发出请求，不等待服务端响应，等服务端处理完毕后，使用通知或轮询的方式告知请求方。一般指：请求——响应——通知 模式。</li>
<li>冗余：增加副本，提高可用性，安全性，性能。</li>
<li>安全：对已知问题有有效的解决方案，对未知/潜在问题建立发现和防御机制。</li>
<li>自动化：将重复的，不需要人工参与的事情，通过工具的方式，使用机器完成。</li>
<li>敏捷性：积极接受需求变更，快速响应业务发展需求。</li>
</ul>
<h3 id="1-4-高性能架构"><a href="#1-4-高性能架构" class="headerlink" title="1.4. 高性能架构"></a>1.4. 高性能架构</h3><p>以用户为中心，提供快速的网页访问体验。主要参数有较短的响应时间，较大的并发处理能力，较高的吞吐量，稳定的性能参数。</p>
<p>可分为前端优化，应用层优化，代码层优化，存储层优化。</p>
<p>前端优化：网站业务逻辑之前的部分；</p>
<p>浏览器优化：减少 Http 请求数，使用浏览器缓存，启用压缩，Css Js 位置，Js 异步，减少 Cookie 传输；</p>
<p>CDN 加速，反向代理；</p>
<p>应用层优化：处理网站业务的服务器。使用缓存，异步，集群</p>
<p>代码优化：合理的架构，多线程，资源复用（对象池，线程池等），良好的数据结构，JVM 调优，单例，Cache 等；</p>
<p>存储优化：缓存，固态硬盘，光纤传输，优化读写，磁盘冗余，分布式存储（HDFS），NOSQL 等；</p>
<h3 id="1-5-高可用架构"><a href="#1-5-高可用架构" class="headerlink" title="1.5. 高可用架构"></a>1.5. 高可用架构</h3><p>大型网站应该在任何时候都可以正常访问。正常提供对外服务。因为大型网站的复杂性，分布式，廉价服务器，开源数据库，操作系统等特点。要保证高可用是很困难的，也就是说网站的故障是不可避免的。</p>
<p>如何提高可用性，就是需要迫切解决的问题。首先，需要从架构级别，在规划的时候，就考虑可用性。行业内一般用几个 9 表示可用性指标。比如四个 9（99.99），一年内允许的不可用时间是 53 分钟。</p>
<p>不同层级使用的策略不同，一般采用冗余备份和失效转移解决高可用问题。</p>
<p>应用层：一般设计为无状态的，对于每次请求，使用哪一台服务器处理是没有影响的。一般使用负载均衡技术（需要解决 Session 同步问题），实现高可用。</p>
<p>服务层：负载均衡，分级管理，快速失败（超时设置），异步调用，服务降级，幂等设计等。</p>
<p>数据层：冗余备份（冷，热备[同步，异步]，温备），失效转移（确认，转移，恢复）。数据高可用方面著名的理论基础是 CAP 理论（持久性，可用性，数据一致性[强一致，用户一致，最终一致]）</p>
<h3 id="1-6-可伸缩架构"><a href="#1-6-可伸缩架构" class="headerlink" title="1.6. 可伸缩架构"></a>1.6. 可伸缩架构</h3><p>伸缩性是指在不改变原有架构设计的基础上，通过添加/减少硬件（服务器）的方式，提高/降低系统的处理能力。</p>
<p>应用层：对应用进行垂直或水平切分。然后针对单一功能进行负载均衡（DNS,HTTP[反向代理],IP,链路层）。</p>
<p>服务层：与应用层类似；</p>
<p>数据层：分库，分表，NOSQL 等；常用算法 Hash，一致性 Hash。</p>
<h3 id="1-7-可扩展架构"><a href="#1-7-可扩展架构" class="headerlink" title="1.7. 可扩展架构"></a>1.7. 可扩展架构</h3><p>可以方便的进行功能模块的新增/移除，提供代码/模块级别良好的可扩展性。</p>
<p>模块化，组件化：高内聚，内耦合，提高复用性，扩展性。</p>
<p>稳定接口：定义稳定的接口，在接口不变的情况下，内部结构可以“随意”变化。</p>
<p>设计模式：应用面向对象思想，原则，使用设计模式，进行代码层面的设计。</p>
<p>消息队列：模块化的系统，通过消息队列进行交互，使模块之间的依赖解耦。</p>
<p>分布式服务：公用模块服务化，提供其他系统使用，提高可重用性，扩展性。</p>
<h3 id="1-8-安全架构"><a href="#1-8-安全架构" class="headerlink" title="1.8. 安全架构"></a>1.8. 安全架构</h3><p>对已知问题有有效的解决方案，对未知/潜在问题建立发现和防御机制。对于安全问题，首先要提高安全意识，建立一个安全的有效机制，从政策层面，组织层面进行保障。比如服务器密码不能泄露，密码每月更新，并且三次内不能重复；每周安全扫描等。以制度化的方式，加强安全体系的建设。同时，需要注意与安全有关的各个环节。安全问题不容忽视。包括基础设施安全，应用系统安全，数据保密安全等。</p>
<p>基础设施安全：硬件采购，操作系统，网络环境方面的安全。一般采用，正规渠道购买高质量的产品，选择安全的操作系统，及时修补漏洞，安装杀毒软件防火墙。防范病毒，后门。设置防火墙策略，建立 DDOS 防御系统，使用攻击检测系统，进行 子网隔离等手段。</p>
<p>​ 应用系统安全：在程序开发时，对已知常用问题，使用正确的方式，在代码层面解决掉。防止跨站脚本攻击（XSS），注入攻击，跨站请求伪造（CSRF），错误信息，HTML 注释，文件上传，路径遍历等。还可以使用 Web 应用防火墙（比如：ModSecurity），进行安全漏洞扫描等措施，加强应用级别的安全。</p>
<p>​ 数据保密安全：存储安全（存在在可靠的设备，实时，定时备份），保存安全（重要的信息加密保存，选择合适的人员复杂保存和检测等），传输安全（防止数据窃取和数据篡改）；</p>
<p>​ 常用的加解密算法（单项散列加密[MD5,SHA]，对称加密[DES,3DES,RC]），非对称加密[RSA]等。</p>
<h3 id="1-9-敏捷性"><a href="#1-9-敏捷性" class="headerlink" title="1.9. 敏捷性"></a>1.9. 敏捷性</h3><p>网站的架构设计，运维管理要适应变化，提供高伸缩性，高扩展性。方便的应对快速的业务发展，突增高流量访问等要求。</p>
<p>除上面介绍的架构要素外，还需要引入敏捷管理，敏捷开发的思想。使业务，产品，技术，运维统一起来，随需应变，快速响应。</p>
<h3 id="1-10-大型架构举例"><a href="#1-10-大型架构举例" class="headerlink" title="1.10. 大型架构举例"></a>1.10. 大型架构举例</h3><p><br><div align="center"><img src="https://images2015.cnblogs.com/blog/820332/201511/820332-20151116062211858-1998556963.png"></div><br></p>
<p>以上采用七层逻辑架构，第一层客户层，第二层前端优化层，第三层应用层，第四层服务层，第五层数据存储层，第六层大数据存储层，第七层大数据处理层。</p>
<p>客户层：支持 PC 浏览器和手机 APP。差别是手机 APP 可以直接访问通过 IP 访问，反向代理服务器。</p>
<p>前端层：使用 DNS 负载均衡，CDN 本地加速以及反向代理服务；</p>
<p>应用层：网站应用集群；按照业务进行垂直拆分，比如商品应用，会员中心等；</p>
<p>服务层：提供公用服务，比如用户服务，订单服务，支付服务等；</p>
<p>数据层：支持关系型数据库集群（支持读写分离），NOSQL 集群，分布式文件系统集群；以及分布式 Cache；</p>
<p>大数据存储层：支持应用层和服务层的日志数据收集，关系数据库和 NOSQL 数据库的结构化和半结构化数据收集；</p>
<p>大数据处理层：通过 Mapreduce 进行离线数据分析或 Storm 实时数据分析，并将处理后的数据存入关系型数据库。（实际使用中，离线数据和实时数据会按照业务要求进行分类处理，并存入不同的数据库中，供应用层或服务层使用）。</p>
<h2 id="2-电商网站架构案例"><a href="#2-电商网站架构案例" class="headerlink" title="2. 电商网站架构案例"></a>2. 电商网站架构案例</h2><h3 id="2-1-网站初级架构"><a href="#2-1-网站初级架构" class="headerlink" title="2.1. 网站初级架构"></a>2.1. 网站初级架构</h3><p>一般网站，刚开始的做法，是三台服务器，一台部署应用，一台部署数据库，一台部署 NFS 文件系统。</p>
<p>这是前几年比较传统的做法，之前见到一个网站 10 万多会员，垂直服装设计门户，N 多图片。使用了一台服务器部署了应用，数据库以及图片存储。出现了很多性能问题。</p>
<p>如下图：</p>
<p><br><div align="center"><img src="https://images2015.cnblogs.com/blog/820332/201511/820332-20151130071801546-1010554271.png"></div><br></p>
<p>但是，目前主流的网站架构已经发生了翻天覆地的变化。一般都会采用集群的方式，进行高可用设计。至少是下面这个样子。</p>
<p><br><div align="center"><img src="https://images2015.cnblogs.com/blog/820332/201511/820332-20151130071816093-197013108.png"></div><br></p>
<p>（1） 使用集群对应用服务器进行冗余，实现高可用；（负载均衡设备可与应用一块部署）</p>
<p>使用数据库主备模式，实现数据备份和高可用；</p>
<h3 id="2-2-系统容量预估"><a href="#2-2-系统容量预估" class="headerlink" title="2.2. 系统容量预估"></a>2.2. 系统容量预估</h3><p>预估步骤：</p>
<p>（1） 注册用户数-日均 UV 量-每日的 PV 量-每天的并发量；</p>
<p>（2） 峰值预估：平常量的 2~3 倍；</p>
<p>（3） 根据并发量（并发，事务数），存储容量计算系统容量。</p>
<p>客户需求：3~5 年用户数达到 1000 万注册用户；</p>
<p>每秒并发数预估：</p>
<p>（1） 每天的 UV 为 200 万（二八原则）；</p>
<p>（2） 每日每天点击浏览 30 次；</p>
<p>（3） PV 量：200*30=6000 万；</p>
<p>（4） 集中访问量：24<em>0.2=4.8 小时会有 6000 万</em>0.8=4800 万（二八原则）；</p>
<p>（5） 每分并发量：4.8*60=288 分钟，每分钟访问 4800/288=16.7 万（约等于）；</p>
<p>（6） 每秒并发量：16.7 万/60=2780（约等于）；</p>
<p>（7） 假设：高峰期为平常值的三倍，则每秒的并发数可以达到 8340 次。</p>
<p>（8） 1 毫秒=1.3 次访问；</p>
<p>没好好学数学后悔了吧？！（不知道以上算是否有错误，呵呵~~）</p>
<p>服务器预估：（以 tomcat 服务器举例）</p>
<p>（1） 按一台 web 服务器，支持每秒 300 个并发计算。平常需要 10 台服务器（约等于）；[tomcat 默认配置是 150]</p>
<p>（2） 高峰期：需要 30 台服务器；</p>
<p>容量预估：70/90 原则</p>
<p>系统 CPU 一般维持在 70%左右的水平，高峰期达到 90%的水平，是不浪费资源，并比较稳定的。内存，IO 类似。</p>
<p>以上预估仅供参考，因为服务器配置，业务逻辑复杂度等都有影响。在此 CPU，硬盘，网络等不再进行评估。</p>
<h3 id="2-3-网站架构分析"><a href="#2-3-网站架构分析" class="headerlink" title="2.3. 网站架构分析"></a>2.3. 网站架构分析</h3><p>根据以上预估，有几个问题：</p>
<ul>
<li>需要部署大量的服务器，高峰期计算，可能要部署 30 台 Web 服务器。并且这三十台服务器，只有秒杀，活动时才会用到，存在大量的浪费。</li>
<li>所有的应用部署在同一台服务器，应用之间耦合严重。需要进行垂直切分和水平切分。</li>
<li>大量应用存在冗余代码</li>
<li>服务器 SESSION 同步耗费大量内存和网络带宽</li>
<li>数据需要频繁访问数据库，数据库访问压力巨大。</li>
</ul>
<p>大型网站一般需要做以下架构优化（优化是架构设计时，就要考虑的，一般从架构/代码级别解决，调优主要是简单参数的调整，比如 JVM 调优；如果调优涉及大量代码改造，就不是调优了，属于重构）：</p>
<ul>
<li>业务拆分</li>
<li>应用集群部署（分布式部署，集群部署和负载均衡）</li>
<li>多级缓存</li>
<li>单点登录（分布式 Session）</li>
<li>数据库集群（读写分离，分库分表）</li>
<li>服务化</li>
<li>消息队列</li>
<li>其他技术</li>
</ul>
<h3 id="2-4-网站架构优化"><a href="#2-4-网站架构优化" class="headerlink" title="2.4. 网站架构优化"></a>2.4. 网站架构优化</h3><h4 id="业务拆分"><a href="#业务拆分" class="headerlink" title="业务拆分"></a>业务拆分</h4><p>根据业务属性进行垂直切分，划分为产品子系统，购物子系统，支付子系统，评论子系统，客服子系统，接口子系统（对接如进销存，短信等外部系统）。</p>
<p>根据业务子系统进行等级定义，可分为核心系统和非核心系统。核心系统：产品子系统，购物子系统，支付子系统；非核心：评论子系统，客服子系统，接口子系统。</p>
<p>业务拆分作用：提升为子系统可由专门的团队和部门负责，专业的人做专业的事，解决模块之间耦合以及扩展性问题；每个子系统单独部署，避免集中部署导致一个应用挂了，全部应用不可用的问题。</p>
<p>等级定义作用：用于流量突发时，对关键应用进行保护，实现优雅降级；保护关键应用不受到影响。</p>
<p>拆分后的架构图：</p>
<p><br><div align="center"><img src="https://images2015.cnblogs.com/blog/820332/201511/820332-20151130073032968-1952416935.png"></div><br></p>
<p>参考部署方案 2<br><br><div align="center"><img src="https://images2015.cnblogs.com/blog/820332/201511/820332-20151130073047530-940494801.png"></div><br></p>
<p>（1） 如上图每个应用单独部署</p>
<p>（2） 核心系统和非核心系统组合部署</p>
<h4 id="应用集群部署（分布式，集群，负载均衡）"><a href="#应用集群部署（分布式，集群，负载均衡）" class="headerlink" title="应用集群部署（分布式，集群，负载均衡）"></a>应用集群部署（分布式，集群，负载均衡）</h4><p>​ 分布式部署：将业务拆分后的应用单独部署，应用直接通过 RPC 进行远程通信；</p>
<p>​ 集群部署：电商网站的高可用要求，每个应用至少部署两台服务器进行集群部署；</p>
<p>​ 负载均衡：是高可用系统必须的，一般应用通过负载均衡实现高可用，分布式服务通过内置的负载均衡实现高可用，关系型数据库通过主备方式实现高可用。</p>
<p>集群部署后架构图：</p>
<p><br><div align="center"><img src="https://images2015.cnblogs.com/blog/820332/201511/820332-20151130073058983-1408763899.png"></div><br></p>
<h4 id="多级缓存"><a href="#多级缓存" class="headerlink" title="多级缓存"></a>多级缓存</h4><p>缓存按照存放的位置一般可分为两类：本地缓存和分布式缓存。本案例采用二级缓存的方式，进行缓存的设计。一级缓存为本地缓存，二级缓存为分布式缓存。（还有页面缓存，片段缓存等，那是更细粒度的划分）</p>
<p>一级缓存，缓存数据字典，和常用热点数据等基本不可变/有规则变化的信息，二级缓存缓存需要的所有缓存。当一级缓存过期或不可用时，访问二级缓存的数据。如果二级缓存也没有，则访问数据库。</p>
<p>缓存的比例，一般 1:4，即可考虑使用缓存。（理论上是 1:2 即可）。</p>
<p><br><div align="center"><img src="https://images2015.cnblogs.com/blog/820332/201511/820332-20151130073113483-523713370.png"></div><br></p>
<p>​ 根据业务特性可使用以下缓存过期策略：</p>
<p>（1） 缓存自动过期；</p>
<p>（2） 缓存触发过期；</p>
<h4 id="单点登录（分布式-Session）"><a href="#单点登录（分布式-Session）" class="headerlink" title="单点登录（分布式 Session）"></a>单点登录（分布式 Session）</h4><p>系统分割为多个子系统，独立部署后，不可避免的会遇到会话管理的问题。一般可采用 Session 同步，Cookies，分布式 Session 方式。电商网站一般采用分布式 Session 实现。</p>
<p>再进一步可以根据分布式 Session，建立完善的单点登录或账户管理系统。</p>
<p><br><div align="center"><img src="https://images2015.cnblogs.com/blog/820332/201511/820332-20151130073125015-707498377.png"></div><br></p>
<p>​ 流程说明</p>
<p>（1） 用户第一次登录时，将会话信息（用户 Id 和用户信息），比如以用户 Id 为 Key，写入分布式 Session；</p>
<p>（2） 用户再次登录时，获取分布式 Session，是否有会话信息，如果没有则调到登录页；</p>
<p>（3） 一般采用 Cache 中间件实现，建议使用 Redis，因为它有持久化功能，方便分布式 Session 宕机后，可以从持久化存储中加载会话信息；</p>
<p>（4） 存入会话时，可以设置会话保持的时间，比如 15 分钟，超过后自动超时；</p>
<p>结合 Cache 中间件，实现的分布式 Session，可以很好的模拟 Session 会话。</p>
<h4 id="数据库集群（读写分离，分库分表）"><a href="#数据库集群（读写分离，分库分表）" class="headerlink" title="数据库集群（读写分离，分库分表）"></a>数据库集群（读写分离，分库分表）</h4><p>大型网站需要存储海量的数据，为达到海量数据存储，高可用，高性能一般采用冗余的方式进行系统设计。一般有两种方式读写分离和分库分表。</p>
<p>读写分离：一般解决读比例远大于写比例的场景，可采用一主一备，一主多备或多主多备方式。</p>
<p>本案例在业务拆分的基础上，结合分库分表和读写分离。如下图：</p>
<p><br><div align="center"><img src="https://images2015.cnblogs.com/blog/820332/201512/820332-20151201062903515-1864482914.png"></div><br></p>
<p>（1） 业务拆分后：每个子系统需要单独的库；</p>
<p>（2） 如果单独的库太大，可以根据业务特性，进行再次分库，比如商品分类库，产品库；</p>
<p>（3） 分库后，如果表中有数据量很大的，则进行分表，一般可以按照 Id，时间等进行分表；（高级的用法是一致性 Hash）</p>
<p>（4） 在分库，分表的基础上，进行读写分离；</p>
<p>相关中间件可参考 Cobar（阿里，目前已不在维护），TDDL（阿里），Atlas（奇虎 360），MyCat（在 Cobar 基础上，国内很多牛人，号称国内第一开源项目）。</p>
<p>分库分表后序列的问题，JOIN，事务的问题，会在分库分表主题分享中，介绍。</p>
<h4 id="服务化"><a href="#服务化" class="headerlink" title="服务化"></a>服务化</h4><p>​将多个子系统公用的功能/模块，进行抽取，作为公用服务使用。比如本案例的会员子系统就可以抽取为公用的服务。</p>
<p><br><div align="center"><img src="https://images2015.cnblogs.com/blog/820332/201512/820332-20151201062916952-1233076938.png"></div><br></p>
<h4 id="消息队列"><a href="#消息队列" class="headerlink" title="消息队列"></a>消息队列</h4><p>​ 消息队列可以解决子系统/模块之间的耦合，实现异步，高可用，高性能的系统。是分布式系统的标准配置。本案例中，消息队列主要应用在购物，配送环节。</p>
<p>（1） 用户下单后，写入消息队列，后直接返回客户端；</p>
<p>（2） 库存子系统：读取消息队列信息，完成减库存；</p>
<p>（3） 配送子系统：读取消息队列信息，进行配送；</p>
<p><br><div align="center"><img src="https://images2015.cnblogs.com/blog/820332/201512/820332-20151201062938155-1893082140.png"></div><br></p>
<p>目前使用较多的 MQ 有 Active MQ,Rabbit MQ,Zero MQ，MS MQ 等，需要根据具体的业务场景进行选择。建议可以研究下 Rabbit MQ。</p>
<h4 id="其他架构（技术）"><a href="#其他架构（技术）" class="headerlink" title="其他架构（技术）"></a>其他架构（技术）</h4><p>除了以上介绍的业务拆分，应用集群，多级缓存，单点登录，数据库集群，服务化，消息队列外。还有 CDN，反向代理，分布式文件系统，大数据处理等系统。</p>
<p>此处不详细介绍，大家可以问度娘/Google，有机会的话也可以分享给大家。</p>
<h3 id="2-5-架构总结"><a href="#2-5-架构总结" class="headerlink" title="2.5. 架构总结"></a>2.5. 架构总结</h3><p><br><div align="center"><img src="https://images2015.cnblogs.com/blog/820332/201512/820332-20151201062949187-431217543.png"></div><br></p>
<p>以上是本次分享的架构总结，其中细节可参考前面分享的内容。其中还有很多可以优化和细化的地方，因为是案例分享，主要针对重要部分做了介绍，工作中需要大家根据具体的业务场景进行架构设计。</p>
<p>以上是电商网站架构案例的分享一共有三篇，从电商网站的需求，到单机架构，逐步演变为常用的，可供参考的分布式架构的原型。除具备功能需求外，还具备一定的高性能，高可用，可伸缩，可扩展等非功能质量需求（架构目标）。</p>
<h2 id="3-资料"><a href="#3-资料" class="headerlink" title="3. 资料"></a>3. 资料</h2><p><a href="https://www.cnblogs.com/itfly8/p/4967966.html" target="_blank" rel="noopener">大型分布式网站架构技术总结</a></p>
<p><a href="https://www.cnblogs.com/itfly8/p/5006197.html" target="_blank" rel="noopener">大型网站架构系列：电商网站架构案例(1)</a></p>
<p><a href="https://www.cnblogs.com/itfly8/p/5006200.html" target="_blank" rel="noopener">大型网站架构系列：电商网站架构案例(2)</a></p>
<p><a href="https://www.cnblogs.com/itfly8/p/5009005.html" target="_blank" rel="noopener">大型网站架构系列：电商网站架构案例(3)</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/blog/tags/分布式/" rel="tag"># 分布式</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/blog/2018/07/05/programming/java/javaweb/distributed/cache/分布式缓存/" rel="next" title="分布式缓存">
                <i class="fa fa-chevron-left"></i> 分布式缓存
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/blog/2018/07/05/programming/java/javaweb/distributed/mq/分布式消息队列/" rel="prev" title="分布式消息队列">
                分布式消息队列 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/blog/images/avatar.gif" alt="Zhang Peng">
            
              <p class="site-author-name" itemprop="name">Zhang Peng</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/blog/archives/">
              
                  <span class="site-state-item-count">381</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/blog/categories/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/blog/tags/index.html">
                  <span class="site-state-item-count">76</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/blog/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/dunwu" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:forbreak@163.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#大型分布式网站架构"><span class="nav-number">1.</span> <span class="nav-text">大型分布式网站架构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-大型分布式网站架构概述"><span class="nav-number">1.1.</span> <span class="nav-text">1. 大型分布式网站架构概述</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-大型网站的特点"><span class="nav-number">1.1.1.</span> <span class="nav-text">1.1. 大型网站的特点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-大型网站架构目标"><span class="nav-number">1.1.2.</span> <span class="nav-text">1.2. 大型网站架构目标</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-大型网站架构模式"><span class="nav-number">1.1.3.</span> <span class="nav-text">1.3. 大型网站架构模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-高性能架构"><span class="nav-number">1.1.4.</span> <span class="nav-text">1.4. 高性能架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-5-高可用架构"><span class="nav-number">1.1.5.</span> <span class="nav-text">1.5. 高可用架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-6-可伸缩架构"><span class="nav-number">1.1.6.</span> <span class="nav-text">1.6. 可伸缩架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-7-可扩展架构"><span class="nav-number">1.1.7.</span> <span class="nav-text">1.7. 可扩展架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-8-安全架构"><span class="nav-number">1.1.8.</span> <span class="nav-text">1.8. 安全架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-9-敏捷性"><span class="nav-number">1.1.9.</span> <span class="nav-text">1.9. 敏捷性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-10-大型架构举例"><span class="nav-number">1.1.10.</span> <span class="nav-text">1.10. 大型架构举例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-电商网站架构案例"><span class="nav-number">1.2.</span> <span class="nav-text">2. 电商网站架构案例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-网站初级架构"><span class="nav-number">1.2.1.</span> <span class="nav-text">2.1. 网站初级架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-系统容量预估"><span class="nav-number">1.2.2.</span> <span class="nav-text">2.2. 系统容量预估</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-网站架构分析"><span class="nav-number">1.2.3.</span> <span class="nav-text">2.3. 网站架构分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-网站架构优化"><span class="nav-number">1.2.4.</span> <span class="nav-text">2.4. 网站架构优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#业务拆分"><span class="nav-number">1.2.4.1.</span> <span class="nav-text">业务拆分</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#应用集群部署（分布式，集群，负载均衡）"><span class="nav-number">1.2.4.2.</span> <span class="nav-text">应用集群部署（分布式，集群，负载均衡）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#多级缓存"><span class="nav-number">1.2.4.3.</span> <span class="nav-text">多级缓存</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#单点登录（分布式-Session）"><span class="nav-number">1.2.4.4.</span> <span class="nav-text">单点登录（分布式 Session）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#数据库集群（读写分离，分库分表）"><span class="nav-number">1.2.4.5.</span> <span class="nav-text">数据库集群（读写分离，分库分表）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#服务化"><span class="nav-number">1.2.4.6.</span> <span class="nav-text">服务化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#消息队列"><span class="nav-number">1.2.4.7.</span> <span class="nav-text">消息队列</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#其他架构（技术）"><span class="nav-number">1.2.4.8.</span> <span class="nav-text">其他架构（技术）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-架构总结"><span class="nav-number">1.2.5.</span> <span class="nav-text">2.5. 架构总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-资料"><span class="nav-number">1.3.</span> <span class="nav-text">3. 资料</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-paper-plane"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhang Peng</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/blog/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/blog/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/blog/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/blog/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/blog/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/blog/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/blog/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
