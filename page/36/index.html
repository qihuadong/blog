<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/blog/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/blog/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/blog/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/blog/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/blog/atom.xml" title="张鹏的博客" type="application/atom+xml">






<meta property="og:type" content="website">
<meta property="og:title" content="张鹏的博客">
<meta property="og:url" content="http://yoursite.com/page/36/index.html">
<meta property="og:site_name" content="张鹏的博客">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="张鹏的博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/blog/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/36/">





  <title>张鹏的博客 - 大道至简，知易行难</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/blog/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">张鹏的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">大道至简，知易行难</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/blog/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/blog/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/blog/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/blog/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/blog/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/blog/2017/11/08/programming/java/spring/web/spring-websocket/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhang Peng">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张鹏的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2017/11/08/programming/java/spring/web/spring-websocket/" itemprop="url">Spring 和 WebSocket</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-08T00:00:00+08:00">
                2017-11-08
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/spring/" itemprop="url" rel="index">
                    <span itemprop="name">spring</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><h3 id="WebSocket-是什么？"><a href="#WebSocket-是什么？" class="headerlink" title="WebSocket 是什么？"></a>WebSocket 是什么？</h3><p><a href="http://websocket.org/" target="_blank" rel="noopener">WebSocket</a> 是一种网络通信协议。<a href="https://tools.ietf.org/html/rfc6455" target="_blank" rel="noopener">RFC6455</a> 定义了它的通信标准。</p>
<p>WebSocket 是 HTML5 开始提供的一种在单个 TCP 连接上进行全双工通讯的协议。</p>
<h3 id="为什么需要-WebSocket-？"><a href="#为什么需要-WebSocket-？" class="headerlink" title="为什么需要 WebSocket ？"></a>为什么需要 WebSocket ？</h3><p>了解计算机网络协议的人，应该都知道：HTTP 协议是一种无状态的、无连接的、单向的应用层协议。它采用了请求/响应模型。通信请求只能由客户端发起，服务端对请求做出应答处理。</p>
<p>这种通信模型有一个弊端：HTTP 协议无法实现服务器主动向客户端发起消息。</p>
<p>这种单向请求的特点，注定了如果服务器有连续的状态变化，客户端要获知就非常麻烦。大多数 Web 应用程序将通过频繁的异步JavaScript和XML（AJAX）请求实现长轮询。轮询的效率低，非常浪费资源（因为必须不停连接，或者 HTTP 连接始终打开）。</p>
<p><br><div align="center"><img src="http://oyz7npk35.bkt.clouddn.com/image/spring/web/ajax-long-polling.png"></div><br></p>
<p>因此，工程师们一直在思考，有没有更好的方法。WebSocket 就是这样发明的。WebSocket 连接允许客户端和服务器之间进行全双工通信，以便任一方都可以通过建立的连接将数据推送到另一端。WebSocket 只需要建立一次连接，就可以一直保持连接状态。这相比于轮询方式的不停建立连接显然效率要大大提高。</p>
<p><br><div align="center"><img src="http://oyz7npk35.bkt.clouddn.com/image/spring/web/websockets-flow.png"></div><br></p>
<h3 id="WebSocket-如何工作？"><a href="#WebSocket-如何工作？" class="headerlink" title="WebSocket 如何工作？"></a>WebSocket 如何工作？</h3><p>Web浏览器和服务器都必须实现 WebSockets 协议来建立和维护连接。由于 WebSockets 连接长期存在，与典型的HTTP连接不同，对服务器有重要的影响。</p>
<p>基于多线程或多进程的服务器无法适用于 WebSockets，因为它旨在打开连接，尽可能快地处理请求，然后关闭连接。任何实际的 WebSockets 服务器端实现都需要一个异步服务器。</p>
<h2 id="WebSocket-客户端"><a href="#WebSocket-客户端" class="headerlink" title="WebSocket 客户端"></a>WebSocket 客户端</h2><p>在客户端，没有必要为 WebSockets 使用 JavaScript 库。实现 WebSockets 的 Web 浏览器将通过 WebSockets 对象公开所有必需的客户端功能（主要指支持 Html5 的浏览器）。</p>
<h3 id="客户端-API"><a href="#客户端-API" class="headerlink" title="客户端 API"></a>客户端 API</h3><p>以下 API 用于创建 WebSocket 对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var Socket = new WebSocket(url, [protocol] );</span><br></pre></td></tr></table></figure>
<p>以上代码中的第一个参数 url, 指定连接的 URL。第二个参数 protocol 是可选的，指定了可接受的子协议。</p>
<h4 id="WebSocket-属性"><a href="#WebSocket-属性" class="headerlink" title="WebSocket 属性"></a>WebSocket 属性</h4><p>以下是 WebSocket 对象的属性。假定我们使用了以上代码创建了 Socket 对象：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>Socket.readyState</td>
<td>只读属性 <strong>readyState</strong> 表示连接状态，可以是以下值：0 - 表示连接尚未建立。1 - 表示连接已建立，可以进行通信。2 - 表示连接正在进行关闭。3 - 表示连接已经关闭或者连接不能打开。</td>
</tr>
<tr>
<td>Socket.bufferedAmount</td>
<td>只读属性 <strong>bufferedAmount</strong> 已被 send() 放入正在队列中等待传输，但是还没有发出的 UTF-8 文本字节数。</td>
</tr>
</tbody>
</table>
<h4 id="WebSocket-事件"><a href="#WebSocket-事件" class="headerlink" title="WebSocket 事件"></a>WebSocket 事件</h4><p>以下是 WebSocket 对象的相关事件。假定我们使用了以上代码创建了 Socket 对象：</p>
<table>
<thead>
<tr>
<th>事件</th>
<th>事件处理程序</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>open</td>
<td>Socket.onopen</td>
<td>连接建立时触发</td>
</tr>
<tr>
<td>message</td>
<td>Socket.onmessage</td>
<td>客户端接收服务端数据时触发</td>
</tr>
<tr>
<td>error</td>
<td>Socket.onerror</td>
<td>通信发生错误时触发</td>
</tr>
<tr>
<td>close</td>
<td>Socket.onclose</td>
<td>连接关闭时触发</td>
</tr>
</tbody>
</table>
<h4 id="WebSocket-方法"><a href="#WebSocket-方法" class="headerlink" title="WebSocket 方法"></a>WebSocket 方法</h4><p>以下是 WebSocket 对象的相关方法。假定我们使用了以上代码创建了 Socket 对象：</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>Socket.send()</td>
<td>使用连接发送数据</td>
</tr>
<tr>
<td>Socket.close()</td>
<td>关闭连接</td>
</tr>
</tbody>
</table>
<p><strong>示例</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化一个 WebSocket 对象</span></span><br><span class="line"><span class="keyword">var</span> ws = <span class="keyword">new</span> WebSocket(<span class="string">"ws://localhost:9998/echo"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 建立 web socket 连接成功触发事件</span></span><br><span class="line">ws.onopen = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 使用 send() 方法发送数据</span></span><br><span class="line">  ws.send(<span class="string">"发送数据"</span>);</span><br><span class="line">  alert(<span class="string">"数据发送中..."</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接收服务端数据时触发事件</span></span><br><span class="line">ws.onmessage = <span class="function"><span class="keyword">function</span> (<span class="params">evt</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> received_msg = evt.data;</span><br><span class="line">  alert(<span class="string">"数据已接收..."</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 断开 web socket 连接成功触发事件</span></span><br><span class="line">ws.onclose = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  alert(<span class="string">"连接已关闭..."</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="WebSocket-服务端"><a href="#WebSocket-服务端" class="headerlink" title="WebSocket 服务端"></a>WebSocket 服务端</h2><p>WebSocket 在服务端的实现非常丰富。Node.js、Java、C++、Python 等多种语言都有自己的解决方案。</p>
<p>以下，介绍我在学习 WebSocket 过程中接触过的 WebSocket 服务端解决方案。</p>
<h3 id="Node-js"><a href="#Node-js" class="headerlink" title="Node.js"></a>Node.js</h3><p>常用的 Node 实现有以下三种。</p>
<ul>
<li><a href="https://github.com/uWebSockets/uWebSockets" target="_blank" rel="noopener">µWebSockets</a></li>
<li><a href="http://socket.io/" target="_blank" rel="noopener">Socket.IO</a></li>
<li><a href="https://github.com/theturtle32/WebSocket-Node" target="_blank" rel="noopener">WebSocket-Node</a></li>
</ul>
<h3 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h3><p>Java 的 web 一般都依托于 servlet 容器。</p>
<p>我使用过的 servlet 容器有：Tomcat、Jetty、Resin。其中Tomcat7、Jetty7及以上版本均开始支持 WebSocket（推荐较新的版本，因为随着版本的更迭，对 WebSocket 的支持可能有变更）。</p>
<p>此外，Spring 框架对 WebSocket 也提供了支持。</p>
<p>虽然，以上应用对于 WebSocket 都有各自的实现。但是，它们都遵循<a href="https://tools.ietf.org/html/rfc6455" target="_blank" rel="noopener">RFC6455</a> 的通信标准，并且 Java API 统一遵循 <a href="http://www.jcp.org/en/jsr/detail?id=356" target="_blank" rel="noopener">JSR 356 - JavaTM API for WebSocket </a> 规范。所以，在实际编码中，API 差异不大。</p>
<h4 id="Spring"><a href="#Spring" class="headerlink" title="Spring"></a>Spring</h4><p>Spring 对于 WebSocket 的支持基于下面的 jar 包：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-websocket<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在 Spring 实现 WebSocket 服务器大概分为以下几步：</p>
<p><strong>创建 WebSocket 处理器</strong></p>
<p>扩展 <code>TextWebSocketHandler</code> 或 <code>BinaryWebSocketHandler</code> ，你可以覆写指定的方法。Spring 在收到 WebSocket 事件时，会自动调用事件对应的方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.web.socket.WebSocketHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.WebSocketSession;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.TextMessage;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyHandler</span> <span class="keyword">extends</span> <span class="title">TextWebSocketHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleTextMessage</span><span class="params">(WebSocketSession session, TextMessage message)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>WebSocketHandler</code> 源码如下，这意味着你的处理器大概可以处理哪些 WebSocket 事件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">WebSocketHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 建立连接后触发的回调</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">afterConnectionEstablished</span><span class="params">(WebSocketSession session)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 收到消息时触发的回调</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(WebSocketSession session, WebSocketMessage&lt;?&gt; message)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 传输消息出错时触发的回调</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">handleTransportError</span><span class="params">(WebSocketSession session, Throwable exception)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 断开连接后触发的回调</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">afterConnectionClosed</span><span class="params">(WebSocketSession session, CloseStatus closeStatus)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 是否处理分片消息</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">supportsPartialMessages</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>配置 WebSocket</strong></p>
<p>配置有两种方式：注解和 xml 。其作用就是将 WebSocket 处理器添加到注册中心。</p>
<ol>
<li>实现 <code>WebSocketConfigurer</code> </li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.web.socket.config.annotation.EnableWebSocket;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.config.annotation.WebSocketConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.config.annotation.WebSocketHandlerRegistry;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSocket</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSocketConfig</span> <span class="keyword">implements</span> <span class="title">WebSocketConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerWebSocketHandlers</span><span class="params">(WebSocketHandlerRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addHandler(myHandler(), <span class="string">"/myHandler"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WebSocketHandler <span class="title">myHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyHandler();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>xml 方式</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:websocket</span>=<span class="string">"http://www.springframework.org/schema/websocket"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/websocket</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/websocket/spring-websocket.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">websocket:handlers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">websocket:mapping</span> <span class="attr">path</span>=<span class="string">"/myHandler"</span> <span class="attr">handler</span>=<span class="string">"myHandler"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">websocket:handlers</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"myHandler"</span> <span class="attr">class</span>=<span class="string">"org.springframework.samples.MyHandler"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>更多配置细节可以参考：<a href="https://docs.spring.io/spring/docs/4.3.12.RELEASE/spring-framework-reference/htmlsingle/#websocket" target="_blank" rel="noopener">Spring  WebSocket 文档</a></p>
</blockquote>
<h4 id="javax-websocket"><a href="#javax-websocket" class="headerlink" title="javax.websocket"></a>javax.websocket</h4><p>如果不想使用 Spring 框架的 WebSocket API，你也可以选择基本的 javax.websocket。</p>
<p>首先，需要引入 API jar 包。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- To write basic javax.websocket against --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;javax.websocket&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;javax.websocket-api&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;1.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>如果使用嵌入式 jetty，你还需要引入它的实现包：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- To run javax.websocket in embedded server --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.eclipse.jetty.websocket<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax-websocket-server-impl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;jetty-version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- To run javax.websocket client --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.eclipse.jetty.websocket<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax-websocket-client-impl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;jetty-version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>@ServerEndpoint</strong></p>
<p>这个注解用来标记一个类是 WebSocket 的处理器。</p>
<p>然后，你可以在这个类中使用下面的注解来表明所修饰的方法是触发事件的回调</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 收到消息触发事件</span></span><br><span class="line"><span class="meta">@OnMessage</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(String message, Session session)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打开连接触发事件</span></span><br><span class="line"><span class="meta">@OnOpen</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onOpen</span><span class="params">(Session session, EndpointConfig config, @PathParam(<span class="string">"id"</span>)</span> String id) </span>&#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭连接触发事件</span></span><br><span class="line"><span class="meta">@OnClose</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClose</span><span class="params">(Session session, CloseReason closeReason)</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 传输消息错误触发事件</span></span><br><span class="line"><span class="meta">@OnError</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable error)</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ServerEndpointConfig.Configurator</strong></p>
<p>编写完处理器，你需要扩展 ServerEndpointConfig.Configurator 类完成配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSocketServerConfigurator</span> <span class="keyword">extends</span> <span class="title">ServerEndpointConfig</span>.<span class="title">Configurator</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">modifyHandshake</span><span class="params">(ServerEndpointConfig sec, HandshakeRequest request, HandshakeResponse response)</span> </span>&#123;</span><br><span class="line">        HttpSession httpSession = (HttpSession) request.getHttpSession();</span><br><span class="line">        sec.getUserProperties().put(HttpSession.class.getName(), httpSession);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后就没有然后了，就是这么简单。</p>
<h2 id="WebSocket-代理"><a href="#WebSocket-代理" class="headerlink" title="WebSocket 代理"></a>WebSocket 代理</h2><p>如果把 WebSocket  的通信看成是电话连接，Nginx 的角色则像是电话接线员，负责将发起电话连接的电话转接到指定的客服。</p>
<p>Nginx 从 <a href="http://nginx.com/blog/websocket-nginx/" target="_blank" rel="noopener">1.3 版</a>开始正式支持 WebSocket 代理。如果你的 web 应用使用了代理服务器 Nginx，那么你还需要为 Nginx 做一些配置，使得它开启 WebSocket 代理功能。</p>
<p>以下为参考配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  # this section is specific to the WebSockets proxying</span><br><span class="line">  location /socket.io &#123;</span><br><span class="line">    proxy_pass http://app_server_wsgiapp/socket.io;</span><br><span class="line">    proxy_redirect off;</span><br><span class="line"></span><br><span class="line">    proxy_set_header Host $host;</span><br><span class="line">    proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line"></span><br><span class="line">    proxy_http_version 1.1;</span><br><span class="line">    proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">    proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line">    proxy_read_timeout 600;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>更多配置细节可以参考：<a href="http://nginx.org/en/docs/http/websocket.html" target="_blank" rel="noopener">Nginx 官方的 websocket 文档</a></p>
</blockquote>
<h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><h3 id="HTTP-和-WebSocket-有什么关系？"><a href="#HTTP-和-WebSocket-有什么关系？" class="headerlink" title="HTTP 和 WebSocket 有什么关系？"></a>HTTP 和 WebSocket 有什么关系？</h3><p>Websocket 其实是一个新协议，跟 HTTP 协议基本没有关系，只是为了兼容现有浏览器的握手规范而已，也就是说它是 HTTP 协议上的一种补充。</p>
<h3 id="Html-和-HTTP-有什么关系？"><a href="#Html-和-HTTP-有什么关系？" class="headerlink" title="Html 和 HTTP 有什么关系？"></a>Html 和 HTTP 有什么关系？</h3><p>Html 是超文本标记语言，是一种用于创建网页的标准标记语言。它是一种技术标准。Html5 是它的最新版本。</p>
<p>Http 是一种网络通信协议。其本身和 Html 没有直接关系。</p>
<h2 id="完整示例"><a href="#完整示例" class="headerlink" title="完整示例"></a>完整示例</h2><p>如果需要完整示例代码，可以参考我的 Github 代码：</p>
<ul>
<li><p><a href="https://github.com/dunwu/spring-notes/tree/master/codes/web/websocket" target="_blank" rel="noopener">Spring 对 WebSocket 支持的示例</a></p>
</li>
<li><p><a href="https://github.com/dunwu/javaee-notes/tree/master/codes/websocket" target="_blank" rel="noopener">嵌入式 Jetty 服务器的 WebSocket 示例</a></p>
<p>spring-websocket 和 jetty 9.3 版本似乎存在兼容性问题，Tomcat则木有问题。</p>
<p>我尝试了好几次，没有找到解决方案，只好使用 Jetty 官方的嵌入式示例在 Jetty 中使用 WebSocket 。</p>
</li>
</ul>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><ul>
<li><p><a href="https://www.zhihu.com/question/20215561" target="_blank" rel="noopener">知乎高票答案——WebSocket是什么原理</a> by <a href="https://www.zhihu.com/people/Ovear" target="_blank" rel="noopener"><em>Ovear</em></a></p>
<p>对 WebSocket 原理的阐述简单易懂。</p>
</li>
<li><p><a href="http://www.ruanyifeng.com/blog/2017/05/websocket.html" target="_blank" rel="noopener">WebSocket 教程</a> <em>by ruanyf</em></p>
<p>阮一峰大神的科普一如既往的浅显易懂。</p>
</li>
<li><p><a href="https://www.fullstackpython.com/websockets.html" target="_blank" rel="noopener">WebSockets</a> by <em>fullstackpython</em></p>
</li>
<li><p><a href="http://nginx.org/en/docs/http/websocket.html" target="_blank" rel="noopener">Nginx 官方的 websocket 文档</a></p>
</li>
<li><p><a href="https://docs.spring.io/spring/docs/4.3.12.RELEASE/spring-framework-reference/htmlsingle/#websocket" target="_blank" rel="noopener">Spring  WebSocket 文档</a></p>
</li>
<li><p><a href="http://tomcat.apache.org/tomcat-7.0-doc/web-socket-howto.html" target="_blank" rel="noopener">Tomcat7 WebSocket 文档</a></p>
</li>
<li><p><a href="https://www.eclipse.org/jetty/documentation/9.4.7.v20170914/websocket-intro.html" target="_blank" rel="noopener">Jetty WebSocket 文档</a></p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/blog/2017/11/08/programming/java/javaweb/javaee/servlet/servlet-introduction/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhang Peng">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张鹏的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2017/11/08/programming/java/javaweb/javaee/servlet/servlet-introduction/" itemprop="url">JavaEE Servlet 简介</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-08T00:00:00+08:00">
                2017-11-08
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/javaee/" itemprop="url" rel="index">
                    <span itemprop="name">javaee</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Servlet-是什么？"><a href="#Servlet-是什么？" class="headerlink" title="Servlet 是什么？"></a>Servlet 是什么？</h2><p>Java Servlet 是运行在 Web 服务器或应用服务器上的程序，它是作为来自 Web 浏览器或其他 HTTP 客户端的请求和 HTTP 服务器上的数据库或应用程序之间的中间层。</p>
<p>使用 Servlet，您可以收集来自网页表单的用户输入，呈现来自数据库或者其他源的记录，还可以动态创建网页。</p>
<p>Java Servlet 通常情况下与使用 CGI（Common Gateway Interface，公共网关接口）实现的程序可以达到异曲同工的效果。但是相比于 CGI，Servlet 有以下几点优势：</p>
<ul>
<li>性能明显更好。</li>
<li>Servlet 在 Web 服务器的地址空间内执行。这样它就没有必要再创建一个单独的进程来处理每个客户端请求。</li>
<li>Servlet 是独立于平台的，因为它们是用 Java 编写的。</li>
<li>服务器上的 Java 安全管理器执行了一系列限制，以保护服务器计算机上的资源。因此，Servlet 是可信的。</li>
<li>Java 类库的全部功能对 Servlet 来说都是可用的。它可以通过 sockets 和 RMI 机制与 applets、数据库或其他软件进行交互。</li>
</ul>
<h2 id="Servlet-架构"><a href="#Servlet-架构" class="headerlink" title="Servlet 架构"></a>Servlet 架构</h2><p>下图显示了 Servlet 在 Web 应用程序中的位置。</p>
<p><br><div align="center"><img src="http://www.runoob.com/wp-content/uploads/2014/07/servlet-arch.jpg"></div><br></p>
<h2 id="Servlet-任务"><a href="#Servlet-任务" class="headerlink" title="Servlet 任务"></a>Servlet 任务</h2><p>Servlet 执行以下主要任务：</p>
<ul>
<li>读取客户端（浏览器）发送的显式的数据。这包括网页上的 HTML 表单，或者也可以是来自 applet 或自定义的 HTTP 客户端程序的表单。</li>
<li>读取客户端（浏览器）发送的隐式的 HTTP 请求数据。这包括 cookies、媒体类型和浏览器能理解的压缩格式等等。</li>
<li>处理数据并生成结果。这个过程可能需要访问数据库，执行 RMI 或 CORBA 调用，调用 Web 服务，或者直接计算得出对应的响应。</li>
<li>发送显式的数据（即文档）到客户端（浏览器）。该文档的格式可以是多种多样的，包括文本文件（HTML 或 XML）、二进制文件（GIF 图像）、Excel 等。</li>
<li>发送隐式的 HTTP 响应到客户端（浏览器）。这包括告诉浏览器或其他客户端被返回的文档类型（例如 HTML），设置 cookies 和缓存参数，以及其他类似的任务。</li>
</ul>
<h2 id="Servlet-包"><a href="#Servlet-包" class="headerlink" title="Servlet 包"></a>Servlet 包</h2><p>Java Servlet 是运行在带有支持 Java Servlet 规范的解释器的 web 服务器上的 Java 类。</p>
<p>Servlet 可以使用  <strong>javax.servlet</strong>  和  <strong>javax.servlet.http</strong>  包创建，它是 Java 企业版的标准组成部分，Java 企业版是支持大型开发项目的 Java 类库的扩展版本。</p>
<p>这些类实现 Java Servlet 和 JSP 规范。在写本教程的时候，二者相应的版本分别是 Java Servlet 2.5 和 JSP 2.1。</p>
<p>Java Servlet 就像任何其他的 Java 类一样已经被创建和编译。在您安装 Servlet 包并把它们添加到您的计算机上的 Classpath 类路径中之后，您就可以通过 JDK 的 Java 编译器或任何其他编译器来编译 Servlet。</p>
<h1 id="Servlet-生命周期"><a href="#Servlet-生命周期" class="headerlink" title="Servlet  生命周期"></a>Servlet  生命周期</h1><p>Servlet 生命周期可被定义为从创建直到毁灭的整个过程。以下是 Servlet 遵循的过程：</p>
<ul>
<li>Servlet 通过调用  <strong>init ()</strong>  方法进行初始化。</li>
<li>Servlet 调用  <strong>service()</strong>  方法来处理客户端的请求。</li>
<li>Servlet 通过调用  <strong>destroy()</strong>  方法终止（结束）。</li>
<li>最后，Servlet 是由 JVM 的垃圾回收器进行垃圾回收的。</li>
</ul>
<p>现在让我们详细讨论生命周期的方法。</p>
<h2 id="init-方法"><a href="#init-方法" class="headerlink" title="init() 方法"></a>init() 方法</h2><p>init 方法被设计成只调用一次。它在第一次创建 Servlet 时被调用，在后续每次用户请求时不再调用。因此，它是用于一次性初始化，就像 Applet 的 init 方法一样。</p>
<p>Servlet 创建于用户第一次调用对应于该 Servlet 的 URL 时，但是您也可以指定 Servlet 在服务器第一次启动时被加载。</p>
<p>当用户调用一个 Servlet 时，就会创建一个 Servlet 实例，每一个用户请求都会产生一个新的线程，适当的时候移交给 doGet 或 doPost 方法。init() 方法简单地创建或加载一些数据，这些数据将被用于 Servlet 的整个生命周期。</p>
<p>init 方法的定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">  <span class="comment">// 初始化代码...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="service-方法"><a href="#service-方法" class="headerlink" title="service() 方法"></a>service() 方法</h2><p>service() 方法是执行实际任务的主要方法。Servlet 容器（即 Web 服务器）调用 service() 方法来处理来自客户端（浏览器）的请求，并把格式化的响应写回给客户端。</p>
<p>每次服务器接收到一个 Servlet 请求时，服务器会产生一个新的线程并调用服务。service() 方法检查 HTTP 请求类型（GET、POST、PUT、DELETE 等），并在适当的时候调用 doGet、doPost、doPut，doDelete 等方法。</p>
<p>下面是该方法的特征：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(ServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                    ServletResponse response)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> ServletException, IOException</span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>service() 方法由容器调用，service 方法在适当的时候调用 doGet、doPost、doPut、doDelete 等方法。所以，您不用对 service() 方法做任何动作，您只需要根据来自客户端的请求类型来重写 doGet() 或 doPost() 即可。</p>
<p>doGet() 和 doPost() 方法是每次服务请求中最常用的方法。下面是这两种方法的特征。</p>
<h2 id="doGet-方法"><a href="#doGet-方法" class="headerlink" title="doGet() 方法"></a>doGet() 方法</h2><p>GET 请求来自于一个 URL 的正常请求，或者来自于一个未指定 METHOD 的 HTML 表单，它由 doGet() 方法处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                  HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">    <span class="comment">// Servlet 代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="doPost-方法"><a href="#doPost-方法" class="headerlink" title="doPost() 方法"></a>doPost() 方法</h2><p>POST 请求来自于一个特别指定了 METHOD 为 POST 的 HTML 表单，它由 doPost() 方法处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                   HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">    <span class="comment">// Servlet 代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="destroy-方法"><a href="#destroy-方法" class="headerlink" title="destroy() 方法"></a>destroy() 方法</h2><p>destroy() 方法只会被调用一次，在 Servlet 生命周期结束时被调用。destroy() 方法可以让您的 Servlet 关闭数据库连接、停止后台线程、把 Cookie 列表或点击计数器写入到磁盘，并执行其他类似的清理活动。</p>
<p>在调用 destroy() 方法之后，servlet 对象被标记为垃圾回收。destroy 方法定义如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 终止化代码...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h2><p>下图显示了一个典型的 Servlet 生命周期方案。</p>
<ul>
<li>第一个到达服务器的 HTTP 请求被委派到 Servlet 容器。</li>
<li>Servlet 容器在调用 service() 方法之前加载 Servlet。</li>
<li>然后 Servlet 容器处理由多个线程产生的多个请求，每个线程执行一个单一的 Servlet 实例的 service() 方法。</li>
</ul>
<p><br><div align="center"><img src="http://www.runoob.com/wp-content/uploads/2014/07/Servlet-LifeCycle.jpg"></div><br></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/blog/2017/11/08/programming/java/spring/core/ioc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhang Peng">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张鹏的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2017/11/08/programming/java/spring/core/ioc/" itemprop="url">Spring IoC</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-08T00:00:00+08:00">
                2017-11-08
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/spring/" itemprop="url" rel="index">
                    <span itemprop="name">spring</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="IoC"><a href="#IoC" class="headerlink" title="IoC"></a>IoC</h1><!-- TOC depthFrom:2 depthTo:3 -->
<ul>
<li><a href="#ioc-概念">IoC 概念</a><ul>
<li><a href="#ioc-是什么">IoC 是什么</a></li>
<li><a href="#ioc-能做什么">IoC 能做什么</a></li>
<li><a href="#依赖注入">依赖注入</a></li>
<li><a href="#ioc-和-di">IoC 和 DI</a></li>
<li><a href="#ioc-容器">IoC 容器</a></li>
<li><a href="#bean">Bean</a></li>
</ul>
</li>
<li><a href="#ioc-容器-1">IoC 容器</a><ul>
<li><a href="#核心接口">核心接口</a></li>
<li><a href="#ioc-容器工作步骤">IoC 容器工作步骤</a></li>
<li><a href="#bean-概述">Bean 概述</a></li>
<li><a href="#依赖">依赖</a></li>
</ul>
</li>
<li><a href="#ioc-容器配置">IoC 容器配置</a><ul>
<li><a href="#xml-配置">Xml 配置</a></li>
<li><a href="#注解配置">注解配置</a></li>
<li><a href="#java-配置">Java 配置</a></li>
</ul>
</li>
</ul>
<!-- /TOC -->
<h2 id="IoC-概念"><a href="#IoC-概念" class="headerlink" title="IoC 概念"></a>IoC 概念</h2><h3 id="IoC-是什么"><a href="#IoC-是什么" class="headerlink" title="IoC 是什么"></a>IoC 是什么</h3><blockquote>
<p><strong>IoC，是 Inversion of Control 的缩写，即控制反转。</strong></p>
<ul>
<li>上层模块不应该依赖于下层模块，它们共同依赖于一个抽象</li>
<li>抽象不能依赖于具体实现，具体实现依赖于抽象</li>
</ul>
<p><em>注：又称为依赖倒置原则。这是设计模式六大原则之一。</em></p>
</blockquote>
<p>IoC 不是什么技术，而是一种设计思想。在 Java 开发中，IoC 意味着将你设计好的对象交给容器控制，而不是传统的在你的对象内部直接控制。如何理解 Ioc 呢？理解 Ioc 的关键是要明确“谁控制谁，控制什么，为何是反转（有反转就应该有正转了），哪些方面反转了”，那我们来深入分析一下：</p>
<ul>
<li><strong>谁控制谁，控制什么：</strong>传统 JavaSE 程序设计，我们直接在对象内部通过 new 进行创建对象，是程序主动去创建依赖对象；而 IoC 是有专门一个容器来创建这些对象，即由 IoC 容器来控制对象的创建；谁控制谁？当然是 IoC 容器控制了对象；控制什么？那就是主要控制了外部资源获取（不只是对象包括比如文件等）。</li>
<li><strong>为何是反转，哪些方面反转了：</strong>有反转就有正转，传统应用程序是由我们自己在对象中主动控制去直接获取依赖对象，也就是正转；而反转则是由容器来帮忙创建及注入依赖对象；为何是反转？因为由容器帮我们查找及注入依赖对象，对象只是被动的接受依赖对象，所以是反转；哪些方面反转了？依赖对象的获取被反转了。</li>
</ul>
<p>用图例说明一下，传统程序设计如图 2-1，都是主动去创建相关对象然后再组合起来：</p>
<p><br><div align="center"><img src="http://sishuok.com/forum/upload/2012/2/19/a02c1e3154ef4be3f15fb91275a26494__1.JPG"></div><br></p>
<p>图 2-1 传统应用程序示意图</p>
<p>当有了 IoC/DI 的容器后，在客户端类中不再主动去创建这些对象了，如图 2-2 所示:</p>
<p><br><div align="center"><img src="http://sishuok.com/forum/upload/2012/2/19/6fdf1048726cc2edcac4fca685f050ac__2.JPG"></div><br></p>
<p>图 2-2 有 IoC/DI 容器后程序结构示意图</p>
<h3 id="IoC-能做什么"><a href="#IoC-能做什么" class="headerlink" title="IoC 能做什么"></a>IoC 能做什么</h3><p>IoC 不是一种技术，只是一种思想，一个重要的面向对象编程的法则，它能指导我们如何设计出松耦合、更优良的程序。传统应用程序都是由我们在类内部主动创建依赖对象，从而导致类与类之间高耦合，难于测试；有了 IoC 容器后，把创建和查找依赖对象的控制权交给了容器，由容器进行注入组合对象，所以对象与对象之间是松散耦合，这样也方便测试，利于功能复用，更重要的是使得程序的整个体系结构变得非常灵活。</p>
<p>其实 IoC 对编程带来的最大改变不是从代码上，而是从思想上，发生了“主从换位”的变化。应用程序原本是老大，要获取什么资源都是主动出击，但是在 IoC/DI 思想中，应用程序就变成被动的了，被动的等待 IoC 容器来创建并注入它所需要的资源了。</p>
<p>IoC 很好的体现了面向对象设计法则之一—— 好莱坞法则：“别找我们，我们找你”；即由 IoC 容器帮对象找相应的依赖对象并注入，而不是由对象主动去找。</p>
<h3 id="依赖注入"><a href="#依赖注入" class="headerlink" title="依赖注入"></a>依赖注入</h3><blockquote>
<p>DI，是 Dependency Injection 的缩写，即依赖注入。</p>
<p>依赖注入是 IoC 的最常见形式。</p>
<p>容器全权负责的组件的装配，它会把符合依赖关系的对象通过 JavaBean 属性或者构造函数传递给需要的对象。</p>
</blockquote>
<p>DI 是组件之间依赖关系由容器在运行期决定，形象的说，即由容器动态的将某个依赖关系注入到组件之中。依赖注入的目的并非为软件系统带来更多功能，而是为了提升组件重用的频率，并为系统搭建一个灵活、可扩展的平台。通过依赖注入机制，我们只需要通过简单的配置，而无需任何代码就可指定目标需要的资源，完成自身的业务逻辑，而不需要关心具体的资源来自何处，由谁实现。</p>
<p>理解 DI 的关键是：“谁依赖谁，为什么需要依赖，谁注入谁，注入了什么”，那我们来深入分析一下：</p>
<ul>
<li><strong>谁依赖于谁：</strong>当然是应用程序依赖于 IoC 容器；</li>
<li><strong>为什么需要依赖：</strong>应用程序需要 IoC 容器来提供对象需要的外部资源；</li>
<li><strong>谁注入谁：</strong>很明显是 IoC 容器注入应用程序某个对象，应用程序依赖的对象；</li>
<li><strong>注入了什么</strong>：就是注入某个对象所需要的外部资源（包括对象、资源、常量数据）。</li>
</ul>
<h3 id="IoC-和-DI"><a href="#IoC-和-DI" class="headerlink" title="IoC 和 DI"></a>IoC 和 DI</h3><p>其实它们是同一个概念的不同角度描述，由于控制反转概念比较含糊（可能只是理解为容器控制对象这一个层面，很难让人想到谁来维护对象关系），所以 2004 年大师级人物 Martin Fowler 又给出了一个新的名字：“依赖注入”，相对 IoC 而言，“依赖注入”明确描述了“被注入对象依赖 IoC 容器配置依赖对象”。</p>
<blockquote>
<p>注：如果想要更加深入的了解 IoC 和 DI，请参考大师级人物 Martin Fowler 的一篇经典文章 <a href="http://www.martinfowler.com/articles/injection.html" target="_blank" rel="noopener">Inversion of Control Containers and the Dependency Injection pattern</a> 。</p>
</blockquote>
<h3 id="IoC-容器"><a href="#IoC-容器" class="headerlink" title="IoC 容器"></a>IoC 容器</h3><p>IoC 容器就是具有依赖注入功能的容器。IoC 容器负责实例化、定位、配置应用程序中的对象及建立这些对象间的依赖。应用程序无需直接在代码中 new 相关的对象，应用程序由 IoC 容器进行组装。在 Spring 中 BeanFactory 是 IoC 容器的实际代表者。</p>
<p>Spring IoC 容器如何知道哪些是它管理的对象呢？这就需要配置文件，Spring IoC 容器通过读取配置文件中的配置元数据，通过元数据对应用中的各个对象进行实例化及装配。一般使用基于 xml 配置文件进行配置元数据，而且 Spring 与配置文件完全解耦的，可以使用其他任何可能的方式进行配置元数据，比如注解、基于 java 文件的、基于属性文件的配置都可以</p>
<p>那 Spring IoC 容器管理的对象叫什么呢？</p>
<h3 id="Bean"><a href="#Bean" class="headerlink" title="Bean"></a>Bean</h3><blockquote>
<p><strong>JavaBean</strong> 是一种 JAVA 语言写成的可重用组件。为写成 JavaBean，类必须是具体的和公共的，并且具有无参数的构造器。JavaBean 对外部通过提供 getter / setter 方法来访问其成员。</p>
</blockquote>
<p>由 IoC 容器管理的那些组成你应用程序的对象我们就叫它 Bean。Bean 就是由 Spring 容器初始化、装配及管理的对象，除此之外，bean 就与应用程序中的其他对象没有什么区别了。那 IoC 怎样确定如何实例化 Bean、管理 Bean 之间的依赖关系以及管理 Bean 呢？这就需要配置元数据，在 Spring 中由 BeanDefinition 代表，后边会详细介绍，配置元数据指定如何实例化 Bean、如何组装 Bean 等。</p>
<h2 id="IoC-容器-1"><a href="#IoC-容器-1" class="headerlink" title="IoC 容器"></a>IoC 容器</h2><h3 id="核心接口"><a href="#核心接口" class="headerlink" title="核心接口"></a>核心接口</h3><p><code>org.springframework.beans</code> 和 <code>org.springframework.context</code> 是 IoC 容器的基础。</p>
<p>在 Spring 中，有两种 IoC 容器：<code>BeanFactory</code> 和 <code>ApplicationContext</code>。</p>
<ul>
<li><code>BeanFactory</code>：Spring 实例化、配置和管理对象的最基本接口。</li>
<li><code>ApplicationContext</code>：BeanFactory 的子接口。它还扩展了其他一些接口，以支持更丰富的功能，如：国际化、访问资源、事件机制、更方便的支持 AOP、在 web 应用中指定应用层上下文等。</li>
</ul>
<p>实际开发中，更推荐使用 <code>ApplicationContext</code> 作为 IoC 容器，因为它的功能远多于 <code>FactoryBean</code>。</p>
<p>常见 <code>ApplicationContext</code> 实现：</p>
<ul>
<li><strong>ClassPathXmlApplicationContext</strong>：<code>ApplicationContext</code> 的实现，从 classpath 获取配置文件；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BeanFactory beanFactory = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"classpath.xml"</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>FileSystemXmlApplicationContext</strong>：<code>ApplicationContext</code> 的实现，从文件系统获取配置文件。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BeanFactory beanFactory = <span class="keyword">new</span> FileSystemXmlApplicationContext(<span class="string">"fileSystemConfig.xml"</span>);</span><br></pre></td></tr></table></figure>
<h3 id="IoC-容器工作步骤"><a href="#IoC-容器工作步骤" class="headerlink" title="IoC 容器工作步骤"></a>IoC 容器工作步骤</h3><p>使用 IoC 容器可分为三步骤：</p>
<ol>
<li>配置元数据：需要配置一些元数据来告诉 Spring，你希望容器如何工作，具体来说，就是如何去初始化、配置、管理 JavaBean 对象。</li>
</ol>
<p>2)  实例化容器：由 IoC 容器解析配置的元数据。IoC 容器的 Bean Reader 读取并解析配置文件，根据定义生成 BeanDefinition 配置元数据对象，IoC 容器根据 BeanDefinition 进行实例化、配置及组装 Bean。</p>
<ol start="3">
<li>使用容器：由客户端实例化容器，获取需要的 Bean。</li>
</ol>
<h4 id="配置元数据"><a href="#配置元数据" class="headerlink" title="配置元数据"></a>配置元数据</h4><blockquote>
<p><strong>元数据（Metadata）</strong><br>又称中介数据、中继数据，为描述数据的数据（data about data），主要是描述数据属性（property）的信息。</p>
</blockquote>
<p>配置元数据的方式：</p>
<ul>
<li><p><strong>基于 xml 配置</strong>：Spring 的传统配置方式。在 <code>&lt;beans&gt;</code> 标签中配置元数据内容。</p>
<p>缺点是当 JavaBean 过多时，产生的配置文件足以让你眼花缭乱。</p>
</li>
<li><p><strong>基于注解配置</strong>：Spring2.5 引入。可以大大简化你的配置。</p>
</li>
<li><p><strong>基于 Java 配置</strong>：可以使用 Java 类来定义 JavaBean 。</p>
<p>为了使用这个新特性，需要用到 <code>@Configuration</code> 、<code>@Bean</code> 、<code>@Import</code> 和 <code>@DependsOn</code> 注解。</p>
</li>
</ul>
<h3 id="Bean-概述"><a href="#Bean-概述" class="headerlink" title="Bean 概述"></a>Bean 概述</h3><p>一个 Spring 容器管理一个或多个 bean。<br>这些 bean 根据你配置的元数据（比如 xml 形式）来创建。<br>Spring IoC 容器本身，并不能识别你配置的元数据。为此，要将这些配置信息转为 Spring 能识别的格式——BeanDefinition 对象。</p>
<h4 id="命名-Bean"><a href="#命名-Bean" class="headerlink" title="命名 Bean"></a>命名 Bean</h4><p>指定 id 和 name 属性不是必须的。<br>Spring 中，并非一定要指定 id 和 name 属性。实际上，Spring 会自动为其分配一个特殊名。<br>如果你需要引用声明的 bean，这时你才需要一个标识。官方推荐驼峰命名法来命名。</p>
<h4 id="支持别名"><a href="#支持别名" class="headerlink" title="支持别名"></a>支持别名</h4><p>可能存在这样的场景，不同系统中对于同一 bean 的命名方式不一样。<br>为了适配，Spring 支持 <code>&lt;alias&gt;</code> 为 bean 添加别名的功能。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">"subsystemA-dataSource"</span> <span class="attr">alias</span>=<span class="string">"subsystemB-dataSource"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">"subsystemA-dataSource"</span> <span class="attr">alias</span>=<span class="string">"myApp-dataSource"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="实例化-Bean"><a href="#实例化-Bean" class="headerlink" title="实例化 Bean"></a>实例化 Bean</h4><p><strong>构造器方式</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"exampleBean"</span> <span class="attr">class</span>=<span class="string">"examples.ExampleBean"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>静态工厂方法</strong></p>
<h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><p>依赖注入<br>依赖注入有两种主要方式：</p>
<ul>
<li>构造器注入</li>
<li>Setter 注入<br>构造器注入有可能出现循环注入的错误。如：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">A</span><span class="params">(B b)</span></span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">B</span><span class="params">(A a)</span></span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>依赖和配置细节</strong><br>使用 depends-on<br>Lazy-initialized Bean<br>自动装配<br>方法注入</p>
<h2 id="IoC-容器配置"><a href="#IoC-容器配置" class="headerlink" title="IoC 容器配置"></a>IoC 容器配置</h2><p>IoC 容器的配置有三种方式：</p>
<ul>
<li>基于 xml 配置</li>
<li>基于注解配置</li>
<li>基于 Java 配置</li>
</ul>
<p>作为 Spring 传统的配置方式，xml 配置方式一般为大家所熟知。</p>
<p>如果厌倦了 xml 配置，Spring 也提供了注解配置方式或 Java 配置方式来简化配置。</p>
<p><strong>本文，将对 Java 配置 IoC 容器做详细的介绍。</strong></p>
<h3 id="Xml-配置"><a href="#Xml-配置" class="headerlink" title="Xml 配置"></a>Xml 配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">         http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">"resource1.xml"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"bean1"</span> <span class="attr">class</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"bean2"</span> <span class="attr">class</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">"bean2"</span> <span class="attr">class</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">alias</span> <span class="attr">alias</span>=<span class="string">"bean3"</span> <span class="attr">name</span>=<span class="string">"bean2"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">"resource2.xml"</span> /&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>标签说明：</p>
<ul>
<li><code>&lt;beans&gt;</code> 是 Spring 配置文件的根节点。</li>
<li><code>&lt;bean&gt;</code> 用来定义一个 JavaBean。<code>id</code> 属性是它的标识，在文件中必须唯一；<code>class</code> 属性是它关联的类。</li>
<li><code>&lt;alias&gt;</code> 用来定义 Bean 的别名。</li>
<li><code>&lt;import&gt;</code> 用来导入其他配置文件的 Bean 定义。这是为了加载多个配置文件，当然也可以把这些配置文件构造为一个数组（new String[] {“config1.xml”, config2.xml}）传给 <code>ApplicationContext</code> 实现类进行加载多个配置文件，那一个更适合由用户决定；这两种方式都是通过调用 Bean Definition Reader 读取 Bean 定义，内部实现没有任何区别。<code>&lt;import&gt;</code> 标签可以放在 <code>&lt;beans&gt;</code> 下的任何位置，没有顺序关系。</li>
</ul>
<h4 id="实例化容器"><a href="#实例化容器" class="headerlink" title="实例化容器"></a>实例化容器</h4><p>实例化容器的过程：<br>定位资源（XML 配置文件）<br>读取配置信息(Resource)<br>转化为 Spring 可识别的数据形式（BeanDefinition）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext context =  </span><br><span class="line">      <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="keyword">new</span> String[] &#123;<span class="string">"services.xml"</span>, <span class="string">"daos.xml"</span>&#125;);</span><br></pre></td></tr></table></figure>
<p>组合 xml 配置文件<br>配置的 Bean 功能各不相同，都放在一个 xml 文件中，不便管理。<br>Java 设计模式讲究职责单一原则。配置其实也是如此，功能不同的 JavaBean 应该被组织在不同的 xml 文件中。然后使用 import 标签把它们统一导入。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">"classpath:spring/applicationContext.xml"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">"/WEB-INF/spring/service.xml"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="使用容器"><a href="#使用容器" class="headerlink" title="使用容器"></a>使用容器</h4><p>使用容器的方式就是通过<code>getBean</code>获取 IoC 容器中的 JavaBean。<br>Spring 也有其他方法去获得 JavaBean，但是 Spring 并不推荐其他方式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// create and configure beans</span></span><br><span class="line">ApplicationContext context =</span><br><span class="line"><span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="keyword">new</span> String[] &#123;<span class="string">"services.xml"</span>, <span class="string">"daos.xml"</span>&#125;);</span><br><span class="line"><span class="comment">// retrieve configured instance</span></span><br><span class="line">PetStoreService service = context.getBean(<span class="string">"petStore"</span>, PetStoreService.class);</span><br><span class="line"><span class="comment">// use configured instance</span></span><br><span class="line">List&lt;String&gt; userList = service.getUsernameList();</span><br></pre></td></tr></table></figure>
<h3 id="注解配置"><a href="#注解配置" class="headerlink" title="注解配置"></a>注解配置</h3><p>Spring2.5 引入了注解。<br>于是，一个问题产生了：<strong>使用注解方式注入 JavaBean 是不是一定完爆 xml 方式？</strong><br>未必。正所谓，仁者见仁智者见智。任何事物都有其优缺点，看你如何取舍。来看看注解的优缺点：<br><strong>优点</strong>：大大减少了配置，并且可以使配置更加精细——类，方法，字段都可以用注解去标记。<br><strong>缺点</strong>：使用注解，不可避免产生了侵入式编程，也产生了一些问题。</p>
<ul>
<li><p>你需要将注解加入你的源码并编译它；</p>
</li>
<li><p>注解往往比较分散，不易管控。</p>
</li>
</ul>
<blockquote>
<p>注：spring 中，先进行注解注入，然后才是 xml 注入，因此如果注入的目标相同，后者会覆盖前者。</p>
</blockquote>
<h4 id="启动注解"><a href="#启动注解" class="headerlink" title="启动注解"></a>启动注解</h4><p>Spring 默认是不启用注解的。如果想使用注解，需要先在 xml 中启动注解。<br>启动方式：在 xml 中加入一个标签，很简单吧。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:annotation-config</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注：<code>&lt;context:annotation-config/&gt;</code> 只会检索定义它的上下文。什么意思呢？就是说，如果你<br>为 DispatcherServlet 指定了一个<code>WebApplicationContext</code>，那么它只在 controller 中查找<code>@Autowired</code>注解，而不会检查其它的路径。</p>
</blockquote>
<h4 id="Spring-注解"><a href="#Spring-注解" class="headerlink" title="Spring 注解"></a>Spring 注解</h4><ul>
<li><strong><code>@Required</code></strong></li>
</ul>
<p><code>@Required</code> 注解只能用于修饰 bean 属性的 setter 方法。受影响的 bean 属性必须在配置时被填充在 xml 配置文件中，否则容器将抛出<code>BeanInitializationException</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationRequired</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String sex;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Required</span> 注解用于bean属性的setter方法并且它指示，受影响的bean属性必须在配置时被填充在xml配置文件中，</span></span><br><span class="line"><span class="comment">     *           否则容器将抛出BeanInitializationException。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Required</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSex</span><span class="params">(String sex)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sex = sex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong><code>@Autowired</code></strong></li>
</ul>
<p><code>@Autowired</code>注解可用于修饰属性、setter 方法、构造方法。</p>
<blockquote>
<p>注：<code>@Autowired</code>注解也可用于修饰构造方法，但如果类中只有默认构造方法，则没有必要。如果有多个构造器，至少应该修饰一个，来告诉容器哪一个必须使用。</p>
</blockquote>
<p>可以使用 JSR330 的注解<code>@Inject</code>来替代<code>@Autowired</code>。</p>
<p><strong>_范例_</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationAutowired</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(AnnotationRequired.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Apple fieldA;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Banana fieldB;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Orange fieldC;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Apple <span class="title">getFieldA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> fieldA;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFieldA</span><span class="params">(Apple fieldA)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.fieldA = fieldA;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Banana <span class="title">getFieldB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> fieldB;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFieldB</span><span class="params">(Banana fieldB)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.fieldB = fieldB;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Orange <span class="title">getFieldC</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> fieldC;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFieldC</span><span class="params">(Orange fieldC)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.fieldC = fieldC;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AnnotationAutowired</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AnnotationAutowired</span><span class="params">(Orange fieldC)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.fieldC = fieldC;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        AbstractApplicationContext ctx =</span><br><span class="line">                        <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"spring/spring-annotation.xml"</span>);</span><br><span class="line"></span><br><span class="line">        AnnotationAutowired annotationAutowired =</span><br><span class="line">                        (AnnotationAutowired) ctx.getBean(<span class="string">"annotationAutowired"</span>);</span><br><span class="line">        log.debug(<span class="string">"fieldA: &#123;&#125;, fieldB:&#123;&#125;, fieldC:&#123;&#125;"</span>, annotationAutowired.getFieldA().getName(),</span><br><span class="line">                        annotationAutowired.getFieldB().getName(),</span><br><span class="line">                        annotationAutowired.getFieldC().getName());</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>xml 中的配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 测试@Autowired --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"apple"</span> <span class="attr">class</span>=<span class="string">"org.zp.notes.spring.beans.annotation.sample.Apple"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"potato"</span> <span class="attr">class</span>=<span class="string">"org.zp.notes.spring.beans.annotation.sample.Banana"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"tomato"</span> <span class="attr">class</span>=<span class="string">"org.zp.notes.spring.beans.annotation.sample.Orange"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"annotationAutowired"</span> <span class="attr">class</span>=<span class="string">"org.zp.notes.spring.beans.annotation.sample.AnnotationAutowired"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong><code>@Qualifier</code></strong></li>
</ul>
<p>在<code>@Autowired</code>注解中，提到了如果发现有多个候选的 bean 都符合修饰类型，Spring 就会抓瞎了。</p>
<p>那么，如何解决这个问题。</p>
<p>可以通过<code>@Qualifier</code>指定 bean 名称来锁定真正需要的那个 bean。</p>
<p><strong>_范例_</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationQualifier</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(AnnotationQualifier.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier</span>(<span class="string">"dog"</span>) <span class="comment">/** 去除这行，会报异常 */</span></span><br><span class="line">    Animal dog;</span><br><span class="line"></span><br><span class="line">    Animal cat;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Animal <span class="title">getDog</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> dog;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDog</span><span class="params">(Animal dog)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.dog = dog;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Animal <span class="title">getCat</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> cat;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCat</span><span class="params">(@Qualifier(<span class="string">"cat"</span>)</span> Animal cat) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.cat = cat;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        AbstractApplicationContext ctx =</span><br><span class="line">                <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"spring/spring-annotation.xml"</span>);</span><br><span class="line"></span><br><span class="line">        AnnotationQualifier annotationQualifier =</span><br><span class="line">                (AnnotationQualifier) ctx.getBean(<span class="string">"annotationQualifier"</span>);</span><br><span class="line"></span><br><span class="line">        log.debug(<span class="string">"Dog name: &#123;&#125;"</span>, annotationQualifier.getDog().getName());</span><br><span class="line">        log.debug(<span class="string">"Cat name: &#123;&#125;"</span>, annotationQualifier.getCat().getName());</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Animal</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span> <span class="keyword">extends</span> <span class="title">Animal</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"狗"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span> <span class="keyword">extends</span> <span class="title">Animal</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"猫"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>xml 中的配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 测试@Qualifier --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dog"</span> <span class="attr">class</span>=<span class="string">"org.zp.notes.spring.beans.annotation.sample.Dog"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"cat"</span> <span class="attr">class</span>=<span class="string">"org.zp.notes.spring.beans.annotation.sample.Cat"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"annotationQualifier"</span> <span class="attr">class</span>=<span class="string">"org.zp.notes.spring.beans.annotation.sample.AnnotationQualifier"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="JSR-250-注解"><a href="#JSR-250-注解" class="headerlink" title="JSR 250 注解"></a>JSR 250 注解</h4><p>@Resource</p>
<p>Spring 支持 JSP250 规定的注解<code>@Resource</code>。这个注解根据指定的名称来注入 bean。</p>
<p>如果没有为<code>@Resource</code>指定名称，它会像<code>@Autowired</code>一样按照类型去寻找匹配。</p>
<p>在 Spring 中，由<code>CommonAnnotationBeanPostProcessor</code>来处理<code>@Resource</code>注解。</p>
<p><strong>_范例_</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationResource</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(AnnotationResource.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span>(name = <span class="string">"flower"</span>)</span><br><span class="line">    Plant flower;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span>(name = <span class="string">"tree"</span>)</span><br><span class="line">    Plant tree;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Plant <span class="title">getFlower</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> flower;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFlower</span><span class="params">(Plant flower)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.flower = flower;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Plant <span class="title">getTree</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> tree;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTree</span><span class="params">(Plant tree)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.tree = tree;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        AbstractApplicationContext ctx =</span><br><span class="line">                        <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"spring/spring-annotation.xml"</span>);</span><br><span class="line"></span><br><span class="line">        AnnotationResource annotationResource =</span><br><span class="line">                        (AnnotationResource) ctx.getBean(<span class="string">"annotationResource"</span>);</span><br><span class="line">        log.debug(<span class="string">"type: &#123;&#125;, name: &#123;&#125;"</span>, annotationResource.getFlower().getClass(), annotationResource.getFlower().getName());</span><br><span class="line">        log.debug(<span class="string">"type: &#123;&#125;, name: &#123;&#125;"</span>, annotationResource.getTree().getClass(), annotationResource.getTree().getName());</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>xml 的配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 测试@Resource --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"flower"</span> <span class="attr">class</span>=<span class="string">"org.zp.notes.spring.beans.annotation.sample.Flower"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"tree"</span> <span class="attr">class</span>=<span class="string">"org.zp.notes.spring.beans.annotation.sample.Tree"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"annotationResource"</span> <span class="attr">class</span>=<span class="string">"org.zp.notes.spring.beans.annotation.sample.AnnotationResource"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong><code>@PostConstruct</code> 和 <code>@PreDestroy</code></strong></li>
</ul>
<p><code>@PostConstruct</code> 和 <code>@PreDestroy</code> 是 JSR 250 规定的用于生命周期的注解。</p>
<p>从其名号就可以看出，一个是在构造之后调用的方法，一个是销毁之前调用的方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationPostConstructAndPreDestroy</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(AnnotationPostConstructAndPreDestroy.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.debug(<span class="string">"call @PostConstruct method"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreDestroy</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.debug(<span class="string">"call @PreDestroy method"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="JSR-330-注解"><a href="#JSR-330-注解" class="headerlink" title="JSR 330 注解"></a>JSR 330 注解</h4><p>从 Spring3.0 开始，Spring 支持 JSR 330 标准注解（依赖注入）。</p>
<p>注：如果要使用 JSR 330 注解，需要使用外部 jar 包。</p>
<p>若你使用 maven 管理 jar 包，只需要添加依赖到 pom.xml 即可：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.inject<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.inject<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>@Inject</p>
<p><code>@Inject</code>和<code>@Autowired</code>一样，可以修饰属性、setter 方法、构造方法。</p>
<p><strong>_范例_</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationInject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(AnnotationInject.class);</span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    Apple fieldA;</span><br><span class="line"></span><br><span class="line">    Banana fieldB;</span><br><span class="line"></span><br><span class="line">    Orange fieldC;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Apple <span class="title">getFieldA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> fieldA;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFieldA</span><span class="params">(Apple fieldA)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.fieldA = fieldA;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Banana <span class="title">getFieldB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> fieldB;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFieldB</span><span class="params">(Banana fieldB)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.fieldB = fieldB;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Orange <span class="title">getFieldC</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> fieldC;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AnnotationInject</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Inject</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AnnotationInject</span><span class="params">(Orange fieldC)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.fieldC = fieldC;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        AbstractApplicationContext ctx =</span><br><span class="line">                        <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"spring/spring-annotation.xml"</span>);</span><br><span class="line">        AnnotationInject annotationInject = (AnnotationInject) ctx.getBean(<span class="string">"annotationInject"</span>);</span><br><span class="line"></span><br><span class="line">        log.debug(<span class="string">"type: &#123;&#125;, name: &#123;&#125;"</span>, annotationInject.getFieldA().getClass(),</span><br><span class="line">                        annotationInject.getFieldA().getName());</span><br><span class="line"></span><br><span class="line">        log.debug(<span class="string">"type: &#123;&#125;, name: &#123;&#125;"</span>, annotationInject.getFieldB().getClass(),</span><br><span class="line">                        annotationInject.getFieldB().getName());</span><br><span class="line"></span><br><span class="line">        log.debug(<span class="string">"type: &#123;&#125;, name: &#123;&#125;"</span>, annotationInject.getFieldC().getClass(),</span><br><span class="line">                        annotationInject.getFieldC().getName());</span><br><span class="line"></span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Java 配置</p>
<p>基于 Java 配置 Spring IoC 容器，实际上是 Spring 允许用户定义一个类，在这个类中去管理 IoC 容器的配置。</p>
<p>为了让 Spring 识别这个定义类为一个 Spring 配置类，需要用到两个注解：@Configuration 和@Bean。</p>
<p>如果你熟悉 Spring 的 xml 配置方式，你可以将@Configuration 等价于<beans>标签；将@Bean 等价于<bean>标签。</bean></beans></p>
<p>@Bean</p>
<p>@Bean 的修饰目标只能是方法或注解。</p>
<p>@Bean 只能定义在@Configuration 或@Component 注解修饰的类中。</p>
<p>声明一个 bean</p>
<p>此外，@Configuration 类允许在同一个类中通过@Bean 定义内部 bean 依赖。</p>
<p>声明一个 bean，只需要在 bean 属性的 set 方法上标注@Bean 即可。</p>
<pre><code>@Configuration
public class AnnotationConfiguration {
    private static final Logger log = LoggerFactory.getLogger(JavaComponentScan.class);

    @Bean
    public Job getPolice() {
        return new Police();
    }

    public static void main(String[] args) {
        AnnotationConfigApplicationContext ctx = new AnnotationConfigApplicationContext(AnnotationConfiguration.class);
        ctx.scan(&quot;org.zp.notes.spring.beans&quot;);
        ctx.refresh();
        Job job = (Job) ctx.getBean(&quot;police&quot;);
        log.debug(&quot;job: {}, work: {}&quot;, job.getClass(), job.work());
    }
}

public interface Job {
    String work();
}

@Component(&quot;police&quot;)
public class Police implements Job {
    @Override
    public String work() {
        return &quot;抓罪犯&quot;;
    }
}
</code></pre><p>这等价于配置</p>
<pre><code>&lt;beans&gt;
    &lt;bean id=&quot;police&quot; class=&quot;org.zp.notes.spring.ioc.sample.job.Police&quot;/&gt;
&lt;/beans&gt;
</code></pre><p>@Bean 注解用来表明一个方法实例化、配置合初始化一个被 Spring IoC 容器管理的新对象。</p>
<p>如果你熟悉 Spring 的 xml 配置，你可以将@Bean 视为等价于<beans>标签。</beans></p>
<p>@Bean 注解可以用于任何的 Spring @Component bean，然而，通常被用于@Configuration bean。</p>
<p>@Configuration</p>
<p>@Configuration 是一个类级别的注解，用来标记被修饰类的对象是一个 BeanDefinition。</p>
<p>@Configuration 类声明 bean 是通过被@Bean 修饰的公共方法。此外，@Configuration 类允许在同一个类中通过@Bean 定义内部 bean 依赖。</p>
<pre><code>@Configuration
public class AppConfig {
    @Bean
    public MyService myService() {
        return new MyServiceImpl();
    }
}
</code></pre><p>这等价于配置</p>
<pre><code>&lt;beans&gt;
    &lt;bean id=&quot;myService&quot; class=&quot;com.acme.services.MyServiceImpl&quot;/&gt;
&lt;/beans&gt;
</code></pre><p>用 AnnotationConfigApplicationContext 实例化 IoC 容器。</p>
<h3 id="Java-配置"><a href="#Java-配置" class="headerlink" title="Java 配置"></a>Java 配置</h3><p>基于 Java 配置 Spring IoC 容器，实际上是<strong>Spring 允许用户定义一个类，在这个类中去管理 IoC 容器的配置</strong>。</p>
<p>为了让 Spring 识别这个定义类为一个 Spring 配置类，需要用到两个注解：<code>@Configuration</code>和<code>@Bean</code>。</p>
<p>如果你熟悉 Spring 的 xml 配置方式，你可以将<code>@Configuration</code>等价于<code>&lt;beans&gt;</code>标签；将<code>@Bean</code>等价于<code>&lt;bean&gt;</code>标签。</p>
<h4 id="Bean-1"><a href="#Bean-1" class="headerlink" title="@Bean"></a>@Bean</h4><p>@Bean 的修饰目标只能是方法或注解。</p>
<p>@Bean 只能定义在<code>@Configuration</code>或<code>@Component</code>注解修饰的类中。</p>
<h4 id="声明一个-bean"><a href="#声明一个-bean" class="headerlink" title="声明一个 bean"></a>声明一个 bean</h4><p>此外，@Configuration 类允许在同一个类中通过@Bean 定义内部 bean 依赖。</p>
<p>声明一个 bean，只需要在 bean 属性的 set 方法上标注@Bean 即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnnotationConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(JavaComponentScan.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Job <span class="title">getPolice</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Police();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AnnotationConfigApplicationContext ctx = <span class="keyword">new</span> AnnotationConfigApplicationContext(AnnotationConfiguration.class);</span><br><span class="line">        ctx.scan(<span class="string">"org.zp.notes.spring.beans"</span>);</span><br><span class="line">        ctx.refresh();</span><br><span class="line">        Job job = (Job) ctx.getBean(<span class="string">"police"</span>);</span><br><span class="line">        log.debug(<span class="string">"job: &#123;&#125;, work: &#123;&#125;"</span>, job.getClass(), job.work());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Job</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">work</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(<span class="string">"police"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Police</span> <span class="keyword">implements</span> <span class="title">Job</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">work</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"抓罪犯"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这等价于配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"police"</span> <span class="attr">class</span>=<span class="string">"org.zp.notes.spring.ioc.sample.job.Police"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>@Bean 注解用来表明一个方法实例化、配置合初始化一个被 Spring IoC 容器管理的新对象。</p>
<p>如果你熟悉 Spring 的 xml 配置，你可以将@Bean 视为等价于<code>&lt;beans&gt;</code>标签。</p>
<p>@Bean 注解可以用于任何的 Spring <code>@Component</code> bean，然而，通常被用于<code>@Configuration</code> bean。</p>
<h4 id="Configuration"><a href="#Configuration" class="headerlink" title="@Configuration"></a>@Configuration</h4><p><code>@Configuration</code> 是一个类级别的注解，用来标记被修饰类的对象是一个<code>BeanDefinition</code>。</p>
<p><code>@Configuration</code> 声明 bean 是通过被 <code>@Bean</code> 修饰的公共方法。此外，<code>@Configuration</code> 允许在同一个类中通过 <code>@Bean</code> 定义内部 bean 依赖。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MyService <span class="title">myService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyServiceImpl();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这等价于配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"myService"</span> <span class="attr">class</span>=<span class="string">"com.acme.services.MyServiceImpl"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>用 <code>AnnotationConfigApplicationContext</code> 实例化 IoC 容器。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/blog/2017/11/08/programming/java/javaweb/javaee/session/cookie-and-sesion/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhang Peng">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张鹏的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2017/11/08/programming/java/javaweb/javaee/session/cookie-and-sesion/" itemprop="url">JavaEE Cookie vs. Session</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-08T00:00:00+08:00">
                2017-11-08
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/javaee/" itemprop="url" rel="index">
                    <span itemprop="name">javaee</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="存取方式"><a href="#存取方式" class="headerlink" title="存取方式"></a>存取方式</h2><p>Cookie 只能保存<code>ASCII</code>字符串，如果需要存取 Unicode 字符或二进制数据，需要进行<code>UTF-8</code>、<code>GBK</code>或<code>BASE64</code>等方式的编码。</p>
<p>Session 可以存取任何类型的数据，甚至是任何 Java 类。可以将 Session 看成是一个 Java 容器类。</p>
<h2 id="隐私安全"><a href="#隐私安全" class="headerlink" title="隐私安全"></a>隐私安全</h2><p>Cookie 存于客户端浏览器，一些客户端的程序可能会窥探、复制或修改 Cookie 内容。</p>
<p>Session 存于服务器，对客户端是透明的，不存在敏感信息泄露的危险。</p>
<h2 id="有效期"><a href="#有效期" class="headerlink" title="有效期"></a>有效期</h2><p>使用 Cookie 可以保证长时间登录有效，只要设置 Cookie 的<code>maxAge</code>属性为一个很大的数字。</p>
<p>而 Session 虽然理论上也可以通过设置很大的数值来保持长时间登录有效，但是，由于 Session 依赖于名为<code>JESSIONID</code>的 Cookie，而 Cookie <code>JESSIONID</code>的<code>maxAge</code>默认为-1，只要关闭了浏览器该 Session 就会失效，因此，Session 不能实现信息永久有效的效果。使用 URL 地址重写也不能实现。</p>
<h2 id="服务器的开销"><a href="#服务器的开销" class="headerlink" title="服务器的开销"></a>服务器的开销</h2><p>由于 Session 是保存在服务器的，每个用户都会产生一个 Session，如果并发访问的用户非常多，会产生很多的 Session，消耗大量的内存。</p>
<p>而 Cookie 由于保存在客户端浏览器上，所以不占用服务器资源。</p>
<h2 id="浏览器的支持"><a href="#浏览器的支持" class="headerlink" title="浏览器的支持"></a>浏览器的支持</h2><p>Cookie 需要浏览器支持才能使用。</p>
<p>如果浏览器不支持 Cookie，需要使用 Session 以及 URL 地址重写。</p>
<p>需要注意的事所有的用到 Session 程序的 URL 都要使用<code>response.encodeURL(StringURL)</code> 或<code>response.encodeRediretURL(String URL)</code>进行 URL 地址重写，否则导致 Session 会话跟踪失效。</p>
<h2 id="跨域名"><a href="#跨域名" class="headerlink" title="跨域名"></a>跨域名</h2><p>Cookie 支持跨域名。</p>
<p>Session 不支持跨域名。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/blog/2017/11/08/programming/java/javaweb/javaee/jsp/jsp-directive/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhang Peng">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张鹏的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2017/11/08/programming/java/javaweb/javaee/jsp/jsp-directive/" itemprop="url">JSP 指令</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-08T00:00:00+08:00">
                2017-11-08
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/javaee/" itemprop="url" rel="index">
                    <span itemprop="name">javaee</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>JSP 指令用来设置整个 JSP 页面相关的属性，如网页的编码方式和脚本语言。</p>
<p>JSP 指令以开<code>&lt;%@</code>开始，以<code>%&gt;</code>结束。</p>
<p>JSP 指令语法格式如下：</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ directive attribute=<span class="string">"value"</span> %&gt;</span><br></pre></td></tr></table></figure>
<p>指令可以有很多个属性，它们以键值对的形式存在，并用逗号隔开。</p>
<p>JSP 中的三种指令标签：</p>
<table>
<thead>
<tr>
<th><strong>指令</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>&lt;%@ page … %&gt;</td>
<td>定义网页依赖属性，比如脚本语言、error 页面、缓存需求等等</td>
</tr>
<tr>
<td>&lt;%@ include … %&gt;</td>
<td>包含其他文件</td>
</tr>
<tr>
<td>&lt;%@ taglib … %&gt;</td>
<td>引入标签库的定义，可以是自定义标签</td>
</tr>
</tbody>
</table>
<h2 id="Page-指令"><a href="#Page-指令" class="headerlink" title="Page 指令"></a>Page 指令</h2><p>Page 指令为容器提供当前页面的使用说明。一个 JSP 页面可以包含多个<code>page</code>指令。</p>
<p>Page 指令的语法格式：</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page attribute=<span class="string">"value"</span> %&gt;</span><br></pre></td></tr></table></figure>
<p>等价的 XML 格式：</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;jsp:directive.page attribute=<span class="string">"value"</span> /&gt;</span><br></pre></td></tr></table></figure>
<p>例：</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=<span class="string">"java"</span> contentType=<span class="string">"text/html; charset=UTF-8"</span> pageEncoding=<span class="string">"UTF-8"</span> %&gt;</span><br></pre></td></tr></table></figure>
<h3 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h3><p>下表列出与 Page 指令相关的属性：</p>
<table>
<thead>
<tr>
<th><strong>属性</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>buffer</td>
<td>指定 out 对象使用缓冲区的大小</td>
</tr>
<tr>
<td>autoFlush</td>
<td>控制 out 对象的   缓存区</td>
</tr>
<tr>
<td>contentType</td>
<td>指定当前 JSP 页面的 MIME 类型和字符编码</td>
</tr>
<tr>
<td>errorPage</td>
<td>指定当 JSP 页面发生异常时需要转向的错误处理页面</td>
</tr>
<tr>
<td>isErrorPage</td>
<td>指定当前页面是否可以作为另一个 JSP 页面的错误处理页面</td>
</tr>
<tr>
<td>extends</td>
<td>指定 servlet 从哪一个类继承</td>
</tr>
<tr>
<td>import</td>
<td>导入要使用的 Java 类</td>
</tr>
<tr>
<td>info</td>
<td>定义 JSP 页面的描述信息</td>
</tr>
<tr>
<td>isThreadSafe</td>
<td>指定对 JSP 页面的访问是否为线程安全</td>
</tr>
<tr>
<td>language</td>
<td>定义 JSP 页面所用的脚本语言，默认是 Java</td>
</tr>
<tr>
<td>session</td>
<td>指定 JSP 页面是否使用 session</td>
</tr>
<tr>
<td>isELIgnored</td>
<td>指定是否执行 EL 表达式</td>
</tr>
<tr>
<td>isScriptingEnabled</td>
<td>确定脚本元素能否被使用</td>
</tr>
</tbody>
</table>
<h2 id="Include-指令"><a href="#Include-指令" class="headerlink" title="Include 指令"></a>Include 指令</h2><p>JSP 可以通过<code>include</code>指令来包含其他文件。</p>
<p>被包含的文件可以是 JSP 文件、HTML 文件或文本文件。包含的文件就好像是该 JSP 文件的一部分，会被同时编译执行。</p>
<p>Include 指令的语法格式如下：</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ include file=<span class="string">"文件相对 url 地址"</span> %&gt;</span><br></pre></td></tr></table></figure>
<p><strong>include</strong>  指令中的文件名实际上是一个相对的 URL 地址。</p>
<p>如果您没有给文件关联一个路径，JSP 编译器默认在当前路径下寻找。</p>
<p>等价的 XML 语法：</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;jsp:directive.include file=<span class="string">"文件相对 url 地址"</span> /&gt;</span><br></pre></td></tr></table></figure>
<h2 id="Taglib-指令"><a href="#Taglib-指令" class="headerlink" title="Taglib 指令"></a>Taglib 指令</h2><p>JSP 允许用户自定义标签，一个自定义标签库就是自定义标签的集合。</p>
<p><code>taglib</code>指令引入一个自定义标签集合的定义，包括库路径、自定义标签。</p>
<p><code>taglib</code>指令的语法：</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ taglib uri=<span class="string">"uri"</span> prefix=<span class="string">"prefixOfTag"</span> %&gt;</span><br></pre></td></tr></table></figure>
<p>uri 属性确定标签库的位置，prefix 属性指定标签库的前缀。</p>
<p>等价的 XML 语法：</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;jsp:directive.taglib uri=<span class="string">"uri"</span> prefix=<span class="string">"prefixOfTag"</span> /&gt;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/blog/2017/11/08/programming/java/spring/integration/spring-and-cache/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhang Peng">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张鹏的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2017/11/08/programming/java/spring/integration/spring-and-cache/" itemprop="url">Spring 集成缓存</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-08T00:00:00+08:00">
                2017-11-08
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/spring/" itemprop="url" rel="index">
                    <span itemprop="name">spring</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><em>Ehcache</em> 是一个成熟的缓存框架，你可以直接使用它来管理你的缓存。<br><em>Spring</em> 提供了对缓存功能的抽象：即允许绑定不同的缓存解决方案（如Ehcache），但本身不直接提供缓存功能的实现。它支持注解方式使用缓存，非常方便。<br>本文先通过Ehcache独立应用的范例来介绍它的基本使用方法，然后再介绍与Spring整合的方法。</p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p><strong>Ehcache是什么？</strong><br>EhCache 是一个纯Java的进程内缓存框架，具有快速、精干等特点。它是Hibernate中的默认缓存框架。<br>Ehcache已经发布了3.1版本。但是本文的讲解基于2.10.2版本。<br>为什么不使用最新版呢？因为Spring4还不能直接整合Ehcache 3.x。虽然可以通过JCache间接整合，Ehcache也支持JCache，但是个人觉得不是很方便。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p><strong>Ehcache</strong><br>如果你的项目使用maven管理，添加以下依赖到你的<em>pom.xml</em>中。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.sf.ehcache<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ehcache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>如果你的项目不使用maven管理，请在 <a href="http://www.ehcache.org/downloads/" target="_blank" rel="noopener">Ehcache官网下载地址</a> 下载jar包。</p>
<p><strong>Spring</strong><br>如果你的项目使用maven管理，添加以下依赖到你的<em>pom.xml</em>中。<br><code>spring-context-support</code>这个jar包中含有Spring对于缓存功能的抽象封装接口。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context-support<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="Ehcache的使用"><a href="#Ehcache的使用" class="headerlink" title="Ehcache的使用"></a>Ehcache的使用</h2><h3 id="HelloWorld范例"><a href="#HelloWorld范例" class="headerlink" title="HelloWorld范例"></a>HelloWorld范例</h3><p>接触一种技术最快最直接的途径总是一个Hello World例子，毕竟动手实践印象更深刻，不是吗？<br>(1) 在classpath下添加<em>ehcache.xml</em><br>添加一个名为<em>helloworld</em>的缓存。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ehcache</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:noNamespaceSchemaLocation</span>=<span class="string">"http://ehcache.org/ehcache.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 磁盘缓存位置 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">diskStore</span> <span class="attr">path</span>=<span class="string">"java.io.tmpdir/ehcache"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 默认缓存 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">defaultCache</span></span></span><br><span class="line"><span class="tag">          <span class="attr">maxEntriesLocalHeap</span>=<span class="string">"10000"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">eternal</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">timeToIdleSeconds</span>=<span class="string">"120"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">timeToLiveSeconds</span>=<span class="string">"120"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">maxEntriesLocalDisk</span>=<span class="string">"10000000"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">diskExpiryThreadIntervalSeconds</span>=<span class="string">"120"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">memoryStoreEvictionPolicy</span>=<span class="string">"LRU"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- helloworld缓存 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">cache</span> <span class="attr">name</span>=<span class="string">"helloworld"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">maxElementsInMemory</span>=<span class="string">"1000"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">eternal</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">timeToIdleSeconds</span>=<span class="string">"5"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">timeToLiveSeconds</span>=<span class="string">"5"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">overflowToDisk</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">memoryStoreEvictionPolicy</span>=<span class="string">"LRU"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ehcache</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>(2) <em>EhcacheDemo.java</em><br>Ehcache会自动加载classpath根目录下名为<em>ehcache.xml</em>文件。<br>EhcacheDemo的工作步骤如下：<br>在EhcacheDemo中，我们引用<em>ehcache.xml</em>声明的名为<em>helloworld</em>的缓存来创建<code>Cache</code>对象；<br>然后我们用一个键值对来实例化<code>Element</code>对象；<br>将<code>Element</code>对象添加到<code>Cache</code>；<br>然后用<code>Cache</code>的get方法获取<code>Element</code>对象。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EhcacheDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// Create a cache manager</span></span><br><span class="line">        <span class="keyword">final</span> CacheManager cacheManager = <span class="keyword">new</span> CacheManager();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// create the cache called "helloworld"</span></span><br><span class="line">        <span class="keyword">final</span> Cache cache = cacheManager.getCache(<span class="string">"helloworld"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// create a key to map the data to</span></span><br><span class="line">        <span class="keyword">final</span> String key = <span class="string">"greeting"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create a data element</span></span><br><span class="line">        <span class="keyword">final</span> Element putGreeting = <span class="keyword">new</span> Element(key, <span class="string">"Hello, World!"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Put the element into the data store</span></span><br><span class="line">        cache.put(putGreeting);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Retrieve the data element</span></span><br><span class="line">        <span class="keyword">final</span> Element getGreeting = cache.get(key);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Print the value</span></span><br><span class="line">        System.out.println(getGreeting.getObjectValue());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>输出<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello, World!</span><br></pre></td></tr></table></figure></p>
<h3 id="Ehcache基本操作"><a href="#Ehcache基本操作" class="headerlink" title="Ehcache基本操作"></a>Ehcache基本操作</h3><p><code>Element</code>、<code>Cache</code>、<code>CacheManager</code>是Ehcache最重要的API。</p>
<ul>
<li>Element：缓存的元素，它维护着一个键值对。</li>
<li>Cache：它是Ehcache的核心类，它有多个<code>Element</code>，并被<code>CacheManager</code>管理。它实现了对缓存的逻辑行为。</li>
<li>CacheManager：<code>Cache</code>的容器对象，并管理着<code>Cache</code>的生命周期。</li>
</ul>
<h4 id="创建CacheManager"><a href="#创建CacheManager" class="headerlink" title="创建CacheManager"></a>创建CacheManager</h4><p>下面的代码列举了创建<code>CacheManager</code>的五种方式。<br>使用静态方法<code>create()</code>会以默认配置来创建单例的<code>CacheManager</code>实例。<br><code>newInstance()</code>方法是一个工厂方法，以默认配置创建一个新的<code>CacheManager</code>实例。<br>此外，<code>newInstance()</code>还有几个重载函数，分别可以通过传入<code>String</code>、<code>URL</code>、<code>InputStream</code>参数来加载配置文件，然后创建<code>CacheManager</code>实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用Ehcache默认配置获取单例的CacheManager实例</span></span><br><span class="line">CacheManager.create();</span><br><span class="line">String[] cacheNames = CacheManager.getInstance().getCacheNames();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用Ehcache默认配置新建一个CacheManager实例</span></span><br><span class="line">CacheManager.newInstance();</span><br><span class="line">String[] cacheNames = manager.getCacheNames();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用不同的配置文件分别创建一个CacheManager实例</span></span><br><span class="line">CacheManager manager1 = CacheManager.newInstance(<span class="string">"src/config/ehcache1.xml"</span>);</span><br><span class="line">CacheManager manager2 = CacheManager.newInstance(<span class="string">"src/config/ehcache2.xml"</span>);</span><br><span class="line">String[] cacheNamesForManager1 = manager1.getCacheNames();</span><br><span class="line">String[] cacheNamesForManager2 = manager2.getCacheNames();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 基于classpath下的配置文件创建CacheManager实例</span></span><br><span class="line">URL url = getClass().getResource(<span class="string">"/anotherconfigurationname.xml"</span>);</span><br><span class="line">CacheManager manager = CacheManager.newInstance(url);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 基于文件流得到配置文件，并创建CacheManager实例</span></span><br><span class="line">InputStream fis = <span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File</span><br><span class="line">(<span class="string">"src/config/ehcache.xml"</span>).getAbsolutePath());</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"> CacheManager manager = CacheManager.newInstance(fis);</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"> fis.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="添加缓存"><a href="#添加缓存" class="headerlink" title="添加缓存"></a>添加缓存</h4><p><strong><em>需要强调一点，<code>Cache</code>对象在用<code>addCache</code>方法添加到<code>CacheManager</code>之前，是无效的。</em></strong><br>使用CacheManager的addCache方法可以根据缓存名将ehcache.xml中声明的cache添加到容器中；它也可以直接将Cache对象添加到缓存容器中。<br><code>Cache</code>有多个构造函数，提供了不同方式去加载缓存的配置参数。<br>有时候，你可能需要使用API来动态的添加缓存，下面的例子就提供了这样的范例。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 除了可以使用xml文件中配置的缓存，你也可以使用API动态增删缓存</span></span><br><span class="line"><span class="comment">// 添加缓存</span></span><br><span class="line">manager.addCache(cacheName);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用默认配置添加缓存</span></span><br><span class="line">CacheManager singletonManager = CacheManager.create();</span><br><span class="line">singletonManager.addCache(<span class="string">"testCache"</span>);</span><br><span class="line">Cache test = singletonManager.getCache(<span class="string">"testCache"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用自定义配置添加缓存，注意缓存未添加进CacheManager之前并不可用</span></span><br><span class="line">CacheManager singletonManager = CacheManager.create();</span><br><span class="line">Cache memoryOnlyCache = <span class="keyword">new</span> Cache(<span class="string">"testCache"</span>, <span class="number">5000</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="number">5</span>, <span class="number">2</span>);</span><br><span class="line">singletonManager.addCache(memoryOnlyCache);</span><br><span class="line">Cache test = singletonManager.getCache(<span class="string">"testCache"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用特定的配置添加缓存</span></span><br><span class="line">CacheManager manager = CacheManager.create();</span><br><span class="line">Cache testCache = <span class="keyword">new</span> Cache(</span><br><span class="line"> <span class="keyword">new</span> CacheConfiguration(<span class="string">"testCache"</span>, maxEntriesLocalHeap)</span><br><span class="line"> .memoryStoreEvictionPolicy(MemoryStoreEvictionPolicy.LFU)</span><br><span class="line"> .eternal(<span class="keyword">false</span>)</span><br><span class="line"> .timeToLiveSeconds(<span class="number">60</span>)</span><br><span class="line"> .timeToIdleSeconds(<span class="number">30</span>)</span><br><span class="line"> .diskExpiryThreadIntervalSeconds(<span class="number">0</span>)</span><br><span class="line"> .persistence(<span class="keyword">new</span> PersistenceConfiguration().strategy(Strategy.LOCALTEMPSWAP)));</span><br><span class="line"> manager.addCache(testCache);</span><br></pre></td></tr></table></figure></p>
<h3 id="删除缓存"><a href="#删除缓存" class="headerlink" title="删除缓存"></a>删除缓存</h3><p>删除缓存比较简单，你只需要将指定的缓存名传入<code>removeCache</code>方法即可。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CacheManager singletonManager = CacheManager.create();</span><br><span class="line">singletonManager.removeCache(<span class="string">"sampleCache1"</span>);</span><br></pre></td></tr></table></figure></p>
<h3 id="实现基本缓存操作"><a href="#实现基本缓存操作" class="headerlink" title="实现基本缓存操作"></a>实现基本缓存操作</h3><p>Cache最重要的两个方法就是put和get，分别用来添加Element和获取Element。<br>Cache还提供了一系列的get、set方法来设置或获取缓存参数，这里不一一列举，更多API操作可参考<a href="http://www.ehcache.org/generated/2.10.2/pdf/Ehcache_API_Developer_Guide.pdf" target="_blank" rel="noopener">官方API开发手册</a>。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试：使用默认配置或使用指定配置来创建CacheManager</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Zhang Peng</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheOperationTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(CacheOperationTest.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用Ehcache默认配置(classpath下的ehcache.xml)获取单例的CacheManager实例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        CacheManager manager = CacheManager.newInstance(<span class="string">"src/test/resources/ehcache/ehcache.xml"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获得Cache的引用</span></span><br><span class="line">        Cache cache = manager.getCache(<span class="string">"userCache"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将一个Element添加到Cache</span></span><br><span class="line">        cache.put(<span class="keyword">new</span> Element(<span class="string">"key1"</span>, <span class="string">"value1"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取Element，Element类支持序列化，所以下面两种方法都可以用</span></span><br><span class="line">        Element element1 = cache.get(<span class="string">"key1"</span>);</span><br><span class="line">        <span class="comment">// 获取非序列化的值</span></span><br><span class="line">        log.debug(<span class="string">"key:&#123;&#125;, value:&#123;&#125;"</span>, element1.getObjectKey(), element1.getObjectValue());</span><br><span class="line">        <span class="comment">// 获取序列化的值</span></span><br><span class="line">        log.debug(<span class="string">"key:&#123;&#125;, value:&#123;&#125;"</span>, element1.getKey(), element1.getValue());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新Cache中的Element</span></span><br><span class="line">        cache.put(<span class="keyword">new</span> Element(<span class="string">"key1"</span>, <span class="string">"value2"</span>));</span><br><span class="line">        Element element2 = cache.get(<span class="string">"key1"</span>);</span><br><span class="line">        log.debug(<span class="string">"key:&#123;&#125;, value:&#123;&#125;"</span>, element2.getObjectKey(), element2.getObjectValue());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取Cache的元素数</span></span><br><span class="line">        log.debug(<span class="string">"cache size:&#123;&#125;"</span>, cache.getSize());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取MemoryStore的元素数</span></span><br><span class="line">        log.debug(<span class="string">"MemoryStoreSize:&#123;&#125;"</span>, cache.getMemoryStoreSize());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取DiskStore的元素数</span></span><br><span class="line">        log.debug(<span class="string">"DiskStoreSize:&#123;&#125;"</span>, cache.getDiskStoreSize());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 移除Element</span></span><br><span class="line">        cache.remove(<span class="string">"key1"</span>);</span><br><span class="line">        log.debug(<span class="string">"cache size:&#123;&#125;"</span>, cache.getSize());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关闭当前CacheManager对象</span></span><br><span class="line">        manager.shutdown();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 关闭CacheManager单例实例</span></span><br><span class="line">        CacheManager.getInstance().shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="缓存配置"><a href="#缓存配置" class="headerlink" title="缓存配置"></a>缓存配置</h3><p>Ehcache支持通过xml文件和API两种方式进行配置。</p>
<h4 id="xml方式"><a href="#xml方式" class="headerlink" title="xml方式"></a>xml方式</h4><p>Ehcache的<code>CacheManager</code>构造函数或工厂方法被调用时，会默认加载classpath下名为<em>ehcache.xml</em>的配置文件。如果加载失败，会加载Ehcache jar包中的<em>ehcache-failsafe.xml</em>文件，这个文件中含有简单的默认配置。<br><strong>ehcache.xml配置参数说明：</strong></p>
<ul>
<li><strong>name</strong>：缓存名称。</li>
<li><strong>maxElementsInMemory</strong>：缓存最大个数。</li>
<li><strong>eternal</strong>：缓存中对象是否为永久的，如果是，超时设置将被忽略，对象从不过期。</li>
<li><strong>timeToIdleSeconds</strong>：置对象在失效前的允许闲置时间（单位：秒）。仅当eternal=false对象不是永久有效时使用，可选属性，默认值是0，也就是可闲置时间无穷大。</li>
<li><strong>timeToLiveSeconds</strong>：缓存数据的生存时间（TTL），也就是一个元素从构建到消亡的最大时间间隔值，这只能在元素不是永久驻留时有效，如果该值是0就意味着元素可以停顿无穷长的时间。</li>
<li><strong>maxEntriesLocalDisk</strong>：当内存中对象数量达到maxElementsInMemory时，Ehcache将会对象写到磁盘中。</li>
<li><strong>overflowToDisk</strong>：内存不足时，是否启用磁盘缓存。</li>
<li><strong>diskSpoolBufferSizeMB</strong>：这个参数设置DiskStore（磁盘缓存）的缓存区大小。默认是30MB。每个Cache都应该有自己的一个缓冲区。</li>
<li><strong>maxElementsOnDisk</strong>：硬盘最大缓存个数。</li>
<li><strong>diskPersistent</strong>：是否在VM重启时存储硬盘的缓存数据。默认值是false。</li>
<li><strong>diskExpiryThreadIntervalSeconds</strong>：磁盘失效线程运行时间间隔，默认是120秒。</li>
<li><strong>memoryStoreEvictionPolicy</strong>：当达到maxElementsInMemory限制时，Ehcache将会根据指定的策略去清理内存。默认策略是LRU（最近最少使用）。你可以设置为FIFO（先进先出）或是LFU（较少使用）。</li>
<li><strong>clearOnFlush</strong>：内存数量最大时是否清除。</li>
</ul>
<p>ehcache.xml的一个范例<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ehcache</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:noNamespaceSchemaLocation</span>=<span class="string">"http://ehcache.org/ehcache.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 磁盘缓存位置 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">diskStore</span> <span class="attr">path</span>=<span class="string">"java.io.tmpdir/ehcache"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 默认缓存 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">defaultCache</span></span></span><br><span class="line"><span class="tag">          <span class="attr">maxEntriesLocalHeap</span>=<span class="string">"10000"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">eternal</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">timeToIdleSeconds</span>=<span class="string">"120"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">timeToLiveSeconds</span>=<span class="string">"120"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">maxEntriesLocalDisk</span>=<span class="string">"10000000"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">diskExpiryThreadIntervalSeconds</span>=<span class="string">"120"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">memoryStoreEvictionPolicy</span>=<span class="string">"LRU"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">persistence</span> <span class="attr">strategy</span>=<span class="string">"localTempSwap"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">defaultCache</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">cache</span> <span class="attr">name</span>=<span class="string">"userCache"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">maxElementsInMemory</span>=<span class="string">"1000"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">eternal</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">timeToIdleSeconds</span>=<span class="string">"3"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">timeToLiveSeconds</span>=<span class="string">"3"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">maxEntriesLocalDisk</span>=<span class="string">"10000000"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">overflowToDisk</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">memoryStoreEvictionPolicy</span>=<span class="string">"LRU"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ehcache</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h4 id="API方式"><a href="#API方式" class="headerlink" title="API方式"></a>API方式</h4><p>xml配置的参数也可以直接通过编程方式来动态的进行配置（dynamicConfig没有设为false）。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Cache cache = manager.getCache(<span class="string">"sampleCache"</span>); </span><br><span class="line">CacheConfiguration config = cache.getCacheConfiguration(); </span><br><span class="line">config.setTimeToIdleSeconds(<span class="number">60</span>); </span><br><span class="line">config.setTimeToLiveSeconds(<span class="number">120</span>); </span><br><span class="line">config.setmaxEntriesLocalHeap(<span class="number">10000</span>); </span><br><span class="line">config.setmaxEntriesLocalDisk(<span class="number">1000000</span>);</span><br></pre></td></tr></table></figure></p>
<p>也可以通过<code>disableDynamicFeatures()</code>方式关闭动态配置开关。配置以后你将无法再以编程方式配置参数。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Cache cache = manager.getCache(<span class="string">"sampleCache"</span>); </span><br><span class="line">cache.disableDynamicFeatures();</span><br></pre></td></tr></table></figure></p>
<h2 id="Spring整合Ehcache"><a href="#Spring整合Ehcache" class="headerlink" title="Spring整合Ehcache"></a>Spring整合Ehcache</h2><p>Spring3.1开始添加了对缓存的支持。和事务功能的支持方式类似，缓存抽象允许底层使用不同的缓存解决方案来进行整合。<br>Spring4.1开始支持JSR-107注解。<br><strong><em>注：我本人使用的Spring版本为4.1.4.RELEASE，目前Spring版本仅支持Ehcache2.5以上版本，但不支持Ehcache3。</em></strong></p>
<h3 id="绑定Ehcache"><a href="#绑定Ehcache" class="headerlink" title="绑定Ehcache"></a>绑定Ehcache</h3><p><code>org.springframework.cache.ehcache.EhCacheManagerFactoryBean</code>这个类的作用是加载Ehcache配置文件。<br><code>org.springframework.cache.ehcache.EhCacheCacheManager</code>这个类的作用是支持net.sf.ehcache.CacheManager。</p>
<p><em>spring-ehcache.xml</em>的配置<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:cache</span>=<span class="string">"http://www.springframework.org/schema/cache"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans/spring-beans-3.0.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/cache</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/cache/spring-cache-3.2.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>ehcache缓存配置管理文件<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"ehcache"</span> <span class="attr">class</span>=<span class="string">"org.springframework.cache.ehcache.EhCacheManagerFactoryBean"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"configLocation"</span> <span class="attr">value</span>=<span class="string">"classpath:ehcache/ehcache.xml"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"cacheManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.cache.ehcache.EhCacheCacheManager"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"cacheManager"</span> <span class="attr">ref</span>=<span class="string">"ehcache"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 启用缓存注解开关 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">cache:annotation-driven</span> <span class="attr">cache-manager</span>=<span class="string">"cacheManager"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="使用Spring的缓存注解"><a href="#使用Spring的缓存注解" class="headerlink" title="使用Spring的缓存注解"></a>使用Spring的缓存注解</h3><h4 id="开启注解"><a href="#开启注解" class="headerlink" title="开启注解"></a>开启注解</h4><p>Spring为缓存功能提供了注解功能，但是你必须启动注解。<br>你有两个选择：<br>(1) 在xml中声明<br>像上一节spring-ehcache.xml中的做法一样，使用<code>&lt;cache:annotation-driven/&gt;</code><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cache:annotation-driven</span> <span class="attr">cache-manager</span>=<span class="string">"cacheManager"</span>/&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>(2) 使用标记注解<br>你也可以通过对一个类进行注解修饰的方式在这个类中使用缓存注解。<br>范例如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="注解基本使用方法"><a href="#注解基本使用方法" class="headerlink" title="注解基本使用方法"></a>注解基本使用方法</h3><p>Spring对缓存的支持类似于对事务的支持。<br>首先使用注解标记方法，相当于定义了切点，然后使用Aop技术在这个方法的调用前、调用后获取方法的入参和返回值，进而实现了缓存的逻辑。<br>下面三个注解都是方法级别：</p>
<h4 id="Cacheable"><a href="#Cacheable" class="headerlink" title="@Cacheable"></a>@Cacheable</h4><p>表明所修饰的方法是可以缓存的：当第一次调用这个方法时，它的结果会被缓存下来，在缓存的有效时间内，以后访问这个方法都直接返回缓存结果，不再执行方法中的代码段。<br>这个注解可以用<code>condition</code>属性来设置条件，如果不满足条件，就不使用缓存能力，直接执行方法。<br>可以使用<code>key</code>属性来指定key的生成规则。</p>
<h4 id="CachePut"><a href="#CachePut" class="headerlink" title="@CachePut"></a>@CachePut</h4><p>与<code>@Cacheable</code>不同，<code>@CachePut</code>不仅会缓存方法的结果，还会执行方法的代码段。<br>它支持的属性和用法都与<code>@Cacheable</code>一致。</p>
<h4 id="CacheEvict"><a href="#CacheEvict" class="headerlink" title="@CacheEvict"></a>@CacheEvict</h4><p>与<code>@Cacheable</code>功能相反，<code>@CacheEvict</code>表明所修饰的方法是用来删除失效或无用的缓存数据。<br>下面是<code>@Cacheable</code>、<code>@CacheEvict</code>和<code>@CachePut</code>基本使用方法的一个集中展示：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="comment">// @Cacheable可以设置多个缓存，形式如：@Cacheable(&#123;"books", "isbns"&#125;)</span></span><br><span class="line">    <span class="meta">@Cacheable</span>(value=&#123;<span class="string">"users"</span>&#125;, key=<span class="string">"#user.id"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> findUserInDB(user.getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Cacheable</span>(value = <span class="string">"users"</span>, condition = <span class="string">"#user.getId() &lt;= 2"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findUserInLimit</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> findUserInDB(user.getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@CachePut</span>(value = <span class="string">"users"</span>, key = <span class="string">"#user.getId()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        updateUserInDB(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@CacheEvict</span>(value = <span class="string">"users"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        removeUserInDB(user.getId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@CacheEvict</span>(value = <span class="string">"users"</span>, allEntries = <span class="keyword">true</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        removeAllInDB();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="Caching"><a href="#Caching" class="headerlink" title="@Caching"></a>@Caching</h4><p>如果需要使用同一个缓存注解（<code>@Cacheable</code>、<code>@CacheEvict</code>或<code>@CachePut</code>）多次修饰一个方法，就需要用到<code>@Caching</code>。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Caching</span>(evict = &#123; <span class="meta">@CacheEvict</span>(<span class="string">"primary"</span>), <span class="meta">@CacheEvict</span>(cacheNames=<span class="string">"secondary"</span>, key=<span class="string">"#p0"</span>) &#125;)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Book <span class="title">importBooks</span><span class="params">(String deposit, Date date)</span></span></span><br></pre></td></tr></table></figure></p>
<h4 id="CacheConfig"><a href="#CacheConfig" class="headerlink" title="@CacheConfig"></a>@CacheConfig</h4><p>与前面的缓存注解不同，这是一个类级别的注解。<br>如果类的所有操作都是缓存操作，你可以使用<code>@CacheConfig</code>来指定类，省去一些配置。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CacheConfig</span>(<span class="string">"books"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookRepositoryImpl</span> <span class="keyword">implements</span> <span class="title">BookRepository</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Cacheable</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Book <span class="title">findBook</span><span class="params">(ISBN isbn)</span> </span>&#123;...&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>如果想参考我的<strong><em>完整代码示例</em></strong>，请<a href="https://github.com/dunwu/spring-notes/tree/master/codes/integration/cache" target="_blank" rel="noopener">点击这里</a>访问我的github。</p>
<p>下面是我在写作时参考的资料或文章。</p>
<ul>
<li><a href="https://github.com/ehcache/ehcache3" target="_blank" rel="noopener">Ehcache github</a></li>
<li><a href="http://www.ehcache.org/documentation/" target="_blank" rel="noopener">Ehcache官方文档</a></li>
<li><a href="http://raychase.iteye.com/blog/1545906" target="_blank" rel="noopener">Ehcache详细解读</a></li>
<li><a href="http://www.ibm.com/developerworks/cn/opensource/os-cn-spring-cache/" target="_blank" rel="noopener">注释驱动的 Spring cache 缓存介绍</a></li>
<li><a href="http://docs.spring.io/spring/docs/current/spring-framework-reference/htmlsingle/" target="_blank" rel="noopener">Spring官方文档4.3.3.RELEASE 第36章缓存抽象</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/blog/2017/08/18/programming/java/javaweb/distributed/mq/ActiveMQ/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhang Peng">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张鹏的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2017/08/18/programming/java/javaweb/distributed/mq/ActiveMQ/" itemprop="url">ActiveMQ</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T00:00:00+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/javaweb/" itemprop="url" rel="index">
                    <span itemprop="name">javaweb</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ActiveMQ"><a href="#ActiveMQ" class="headerlink" title="ActiveMQ"></a>ActiveMQ</h1><!-- TOC depthFrom:2 depthTo:3 -->
<ul>
<li><a href="#1-jms-基本概念">1. JMS 基本概念</a><ul>
<li><a href="#11-消息模型">1.1. 消息模型</a></li>
<li><a href="#12-jms-编程模型">1.2. JMS 编程模型</a></li>
</ul>
</li>
<li><a href="#2-安装">2. 安装</a></li>
<li><a href="#3-项目中的应用">3. 项目中的应用</a></li>
<li><a href="#4-资源">4. 资源</a></li>
</ul>
<!-- /TOC -->
<h2 id="1-JMS-基本概念"><a href="#1-JMS-基本概念" class="headerlink" title="1. JMS 基本概念"></a>1. JMS 基本概念</h2><p><code>JMS</code> 即 <strong>Java 消息服务（Java Message Service）API</strong>，是一个 Java 平台中关于面向消息中间件的 API。它用于在两个应用程序之间，或分布式系统中发送消息，进行异步通信。Java 消息服务是一个与具体平台无关的 API，绝大多数 MOM 提供商都对 JMS 提供支持。</p>
<h3 id="1-1-消息模型"><a href="#1-1-消息模型" class="headerlink" title="1.1. 消息模型"></a>1.1. 消息模型</h3><p>JMS 有两种消息模型：</p>
<ul>
<li>Point-to-Point(P2P)</li>
<li>Publish/Subscribe(Pub/Sub)</li>
</ul>
<h4 id="P2P-的特点"><a href="#P2P-的特点" class="headerlink" title="P2P 的特点"></a>P2P 的特点</h4><p><br><div align="center"><img src="http://oyz7npk35.bkt.clouddn.com//image/java/libs/activemq/jms-pointToPoint.gif"></div><br></p>
<p>在点对点的消息系统中，消息分发给一个单独的使用者。点对点消息往往与队列 <code>javax.jms.Queue</code> 相关联。</p>
<p>每个消息只有一个消费者（Consumer）(即一旦被消费，消息就不再在消息队列中)。</p>
<p>发送者和接收者之间在时间上没有依赖性，也就是说当发送者发送了消息之后，不管接收者有没有正在运行，它不会影响到消息被发送到队列。</p>
<p>接收者在成功接收消息之后需向队列应答成功。</p>
<p>如果你希望发送的每个消息都应该被成功处理的话，那么你需要 P2P 模式。</p>
<h4 id="Pub-Sub-的特点"><a href="#Pub-Sub-的特点" class="headerlink" title="Pub/Sub 的特点"></a>Pub/Sub 的特点</h4><p><br><div align="center"><img src="http://oyz7npk35.bkt.clouddn.com//image/java/libs/activemq/jms-publishSubscribe.gif"></div><br></p>
<p>发布/订阅消息系统支持一个事件驱动模型，消息生产者和消费者都参与消息的传递。生产者发布事件，而使用者订阅感兴趣的事件，并使用事件。该类型消息一般与特定的主题 <code>javax.jms.Topic</code> 关联。</p>
<p>每个消息可以有多个消费者。</p>
<p>发布者和订阅者之间有时间上的依赖性。针对某个主题（Topic）的订阅者，它必须创建一个订阅者之后，才能消费发布者的消息，而且为了消费消息，订阅者必须保持运行的状态。</p>
<p>为了缓和这样严格的时间相关性，JMS 允许订阅者创建一个可持久化的订阅。这样，即使订阅者没有被激活（运行），它也能接收到发布者的消息。</p>
<p>如果你希望发送的消息可以不被做任何处理、或者被一个消息者处理、或者可以被多个消费者处理的话，那么可以采用 Pub/Sub 模型。</p>
<h3 id="1-2-JMS-编程模型"><a href="#1-2-JMS-编程模型" class="headerlink" title="1.2. JMS 编程模型"></a>1.2. JMS 编程模型</h3><p><br><div align="center"><img src="http://oyz7npk35.bkt.clouddn.com//image/java/libs/activemq/jms-publishSubscribe.gif"></div><br></p>
<h4 id="ConnectionFactory"><a href="#ConnectionFactory" class="headerlink" title="ConnectionFactory"></a>ConnectionFactory</h4><p>创建 <code>Connection</code> 对象的工厂，针对两种不同的 jms 消息模型，分别有 <code>QueueConnectionFactory</code> 和<code>TopicConnectionFactory</code> 两种。可以通过 JNDI 来查找 <code>ConnectionFactory</code> 对象。</p>
<h4 id="Connection"><a href="#Connection" class="headerlink" title="Connection"></a>Connection</h4><p><code>Connection</code> 表示在客户端和 JMS 系统之间建立的链接（对 TCP/IP socket 的包装）。<code>Connection</code> 可以产生一个或多个<code>Session</code>。跟 <code>ConnectionFactory</code> 一样，<code>Connection</code> 也有两种类型：<code>QueueConnection</code> 和 <code>TopicConnection</code>。</p>
<h4 id="Destination"><a href="#Destination" class="headerlink" title="Destination"></a>Destination</h4><p><code>Destination</code> 是一个包装了消息目标标识符的被管对象。消息目标是指消息发布和接收的地点，或者是队列 <code>Queue</code> ，或者是主题 <code>Topic</code> 。JMS 管理员创建这些对象，然后用户通过 JNDI 发现它们。和连接工厂一样，管理员可以创建两种类型的目标，点对点模型的 <code>Queue</code>，以及发布者/订阅者模型的 <code>Topic</code>。</p>
<h4 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h4><p><code>Session</code> 表示一个单线程的上下文，用于发送和接收消息。由于会话是单线程的，所以消息是连续的，就是说消息是按照发送的顺序一个一个接收的。会话的好处是它支持事务。如果用户选择了事务支持，会话上下文将保存一组消息，直到事务被提交才发送这些消息。在提交事务之前，用户可以使用回滚操作取消这些消息。一个会话允许用户创建消息，生产者来发送消息，消费者来接收消息。同样，<code>Session</code> 也分 <code>QueueSession</code> 和 <code>TopicSession</code>。</p>
<h4 id="MessageConsumer"><a href="#MessageConsumer" class="headerlink" title="MessageConsumer"></a>MessageConsumer</h4><p><code>MessageConsumer</code> 由 <code>Session</code> 创建，并用于将消息发送到 <code>Destination</code>。消费者可以同步地（阻塞模式），或（非阻塞）接收 <code>Queue</code> 和 <code>Topic</code> 类型的消息。同样，消息生产者分两种类型：<code>QueueSender</code> 和<code>TopicPublisher</code>。</p>
<h4 id="MessageProducer"><a href="#MessageProducer" class="headerlink" title="MessageProducer"></a>MessageProducer</h4><p><code>MessageProducer</code> 由 <code>Session</code> 创建，用于接收被发送到 <code>Destination</code> 的消息。<code>MessageProducer</code> 有两种类型：<code>QueueReceiver</code> 和 <code>TopicSubscriber</code>。可分别通过 <code>session</code> 的 <code>createReceiver(Queue)</code> 或 <code>createSubscriber(Topic)</code> 来创建。当然，也可以 <code>session</code> 的 <code>creatDurableSubscriber</code> 方法来创建持久化的订阅者。</p>
<h4 id="Message"><a href="#Message" class="headerlink" title="Message"></a>Message</h4><p>是在消费者和生产者之间传送的对象，也就是说从一个应用程序传送到另一个应用程序。一个消息有三个主要部分：</p>
<ul>
<li>消息头（必须）：包含用于识别和为消息寻找路由的操作设置。</li>
<li>一组消息属性（可选）：包含额外的属性，支持其他提供者和用户的兼容。可以创建定制的字段和过滤器（消息选择器）。</li>
<li>一个消息体（可选）：允许用户创建五种类型的消息（文本消息，映射消息，字节消息，流消息和对象消息）。</li>
</ul>
<p>消息接口非常灵活，并提供了许多方式来定制消息的内容。</p>
<table>
<thead>
<tr>
<th>Common</th>
<th>Point-to-Point</th>
<th>Publish-Subscribe</th>
</tr>
</thead>
<tbody>
<tr>
<td>ConnectionFactory</td>
<td>QueueConnectionFactory</td>
<td>TopicConnectionFactory</td>
</tr>
<tr>
<td>Connection</td>
<td>QueueConnection</td>
<td>TopicConnection</td>
</tr>
<tr>
<td>Destination</td>
<td>Queue</td>
<td>Topic</td>
</tr>
<tr>
<td>Session</td>
<td>QueueSession</td>
<td>TopicSession</td>
</tr>
<tr>
<td>MessageProducer</td>
<td>QueueSender</td>
<td>TopicPublisher</td>
</tr>
<tr>
<td>MessageSender</td>
<td>QueueReceiver, QueueBrowser</td>
<td>TopicSubscriber</td>
</tr>
</tbody>
</table>
<h2 id="2-安装"><a href="#2-安装" class="headerlink" title="2. 安装"></a>2. 安装</h2><p><strong>安装条件</strong></p>
<p>JDK1.7 及以上版本</p>
<p>本地配置了 <strong>JAVA_HOME</strong> 环境变量。</p>
<p><strong>下载</strong></p>
<p>支持 Windows/Unix/Linux/Cygwin</p>
<p><a href="http://activemq.apache.org/download.html" target="_blank" rel="noopener">ActiveMQ 官方下载地址</a></p>
<p><strong>Windows 下运行</strong></p>
<ol>
<li>解压压缩包到本地；</li>
<li>打开控制台，进入安装目录的 <code>bin</code> 目录下；</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd [activemq_install_dir]</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>执行 <code>activemq start</code> 来启动 ActiveMQ</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin\activemq start</span><br></pre></td></tr></table></figure>
<p><strong>测试安装是否成功</strong></p>
<ol>
<li>ActiveMQ 默认监听端口为 61616</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -an|find “61616”</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><p>访问 <a href="http://127.0.0.1:8161/admin/" target="_blank" rel="noopener">http://127.0.0.1:8161/admin/</a></p>
</li>
<li><p>输入用户名、密码<br>Login: admin<br>Passwort: admin</p>
</li>
<li><p>点击导航栏的 Queues 菜单</p>
</li>
<li><p>添加一个队列（queue）</p>
</li>
</ol>
<h2 id="3-项目中的应用"><a href="#3-项目中的应用" class="headerlink" title="3. 项目中的应用"></a>3. 项目中的应用</h2><p><strong>引入依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.activemq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activemq-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.14.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>Sender.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Sender</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SEND_NUMBER = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ConnectionFactory ：连接工厂，JMS 用它创建连接</span></span><br><span class="line">        ConnectionFactory connectionFactory;</span><br><span class="line">        <span class="comment">// Connection ：JMS 客户端到JMS Provider 的连接</span></span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// Session： 一个发送或接收消息的线程</span></span><br><span class="line">        Session session;</span><br><span class="line">        <span class="comment">// Destination ：消息的目的地;消息发送给谁.</span></span><br><span class="line">        Destination destination;</span><br><span class="line">        <span class="comment">// MessageProducer：消息发送者</span></span><br><span class="line">        MessageProducer producer;</span><br><span class="line">        <span class="comment">// TextMessage message;</span></span><br><span class="line">        <span class="comment">// 构造ConnectionFactory实例对象，此处采用ActiveMq的实现jar</span></span><br><span class="line">        connectionFactory = <span class="keyword">new</span> ActiveMQConnectionFactory(</span><br><span class="line">                ActiveMQConnection.DEFAULT_USER,</span><br><span class="line">                ActiveMQConnection.DEFAULT_PASSWORD,</span><br><span class="line">                <span class="string">"tcp://localhost:61616"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 构造从工厂得到连接对象</span></span><br><span class="line">            connection = connectionFactory.createConnection();</span><br><span class="line">            <span class="comment">// 启动</span></span><br><span class="line">            connection.start();</span><br><span class="line">            <span class="comment">// 获取操作连接</span></span><br><span class="line">            session = connection.createSession(Boolean.TRUE,</span><br><span class="line">                    Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">            <span class="comment">// 获取session注意参数值xingbo.xu-queue是一个服务器的queue，须在在ActiveMq的console配置</span></span><br><span class="line">            destination = session.createQueue(<span class="string">"FirstQueue"</span>);</span><br><span class="line">            <span class="comment">// 得到消息生成者【发送者】</span></span><br><span class="line">            producer = session.createProducer(destination);</span><br><span class="line">            <span class="comment">// 设置不持久化，此处学习，实际根据项目决定</span></span><br><span class="line">            producer.setDeliveryMode(DeliveryMode.NON_PERSISTENT);</span><br><span class="line">            <span class="comment">// 构造消息，此处写死，项目就是参数，或者方法获取</span></span><br><span class="line">            sendMessage(session, producer);</span><br><span class="line">            session.commit();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != connection)</span><br><span class="line">                    connection.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable ignore) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(Session session, MessageProducer producer)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= SEND_NUMBER; i++) &#123;</span><br><span class="line">            TextMessage message = session</span><br><span class="line">                    .createTextMessage(<span class="string">"ActiveMq 发送的消息"</span> + i);</span><br><span class="line">            <span class="comment">// 发送消息到目的地方</span></span><br><span class="line">            System.out.println(<span class="string">"发送消息："</span> + <span class="string">"ActiveMq 发送的消息"</span> + i);</span><br><span class="line">            producer.send(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Receiver.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Receiver</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ConnectionFactory ：连接工厂，JMS 用它创建连接</span></span><br><span class="line">        ConnectionFactory connectionFactory;</span><br><span class="line">        <span class="comment">// Connection ：JMS 客户端到JMS Provider 的连接</span></span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// Session： 一个发送或接收消息的线程</span></span><br><span class="line">        Session session;</span><br><span class="line">        <span class="comment">// Destination ：消息的目的地;消息发送给谁.</span></span><br><span class="line">        Destination destination;</span><br><span class="line">        <span class="comment">// 消费者，消息接收者</span></span><br><span class="line">        MessageConsumer consumer;</span><br><span class="line">        connectionFactory = <span class="keyword">new</span> ActiveMQConnectionFactory(</span><br><span class="line">                ActiveMQConnection.DEFAULT_USER,</span><br><span class="line">                ActiveMQConnection.DEFAULT_PASSWORD,</span><br><span class="line">                <span class="string">"tcp://localhost:61616"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 构造从工厂得到连接对象</span></span><br><span class="line">            connection = connectionFactory.createConnection();</span><br><span class="line">            <span class="comment">// 启动</span></span><br><span class="line">            connection.start();</span><br><span class="line">            <span class="comment">// 获取操作连接</span></span><br><span class="line">            session = connection.createSession(Boolean.FALSE,</span><br><span class="line">                    Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">            <span class="comment">// 获取session注意参数值xingbo.xu-queue是一个服务器的queue，须在在ActiveMq的console配置</span></span><br><span class="line">            destination = session.createQueue(<span class="string">"FirstQueue"</span>);</span><br><span class="line">            consumer = session.createConsumer(destination);</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="comment">//设置接收者接收消息的时间，为了便于测试，这里谁定为100s</span></span><br><span class="line">                TextMessage message = (TextMessage) consumer.receive(<span class="number">100000</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != message) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"收到消息"</span> + message.getText());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != connection)</span><br><span class="line">                    connection.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable ignore) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>运行</strong></p>
<p>先运行 Receiver.java 进行消息监听，再运行 Send.java 发送消息。</p>
<p><strong>输出</strong></p>
<p>Send 的输出内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">发送消息：Activemq 发送消息0</span><br><span class="line">发送消息：Activemq 发送消息1</span><br><span class="line">发送消息：Activemq 发送消息2</span><br><span class="line">发送消息：Activemq 发送消息3</span><br></pre></td></tr></table></figure>
<p>Receiver 的输出内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">收到消息ActiveMQ 发送消息0</span><br><span class="line">收到消息ActiveMQ 发送消息1</span><br><span class="line">收到消息ActiveMQ 发送消息2</span><br><span class="line">收到消息ActiveMQ 发送消息3</span><br></pre></td></tr></table></figure>
<h2 id="4-资源"><a href="#4-资源" class="headerlink" title="4. 资源"></a>4. 资源</h2><ul>
<li><a href="http://activemq.apache.org/" target="_blank" rel="noopener">ActiveMQ 官网</a></li>
<li><a href="https://docs.oracle.com/cd/E19575-01/819-3669/6n5sg7cgq/index.html" target="_blank" rel="noopener">oracle 官方的 jms 介绍</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/blog/2017/08/18/programming/java/javastack/javalib/jsoup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhang Peng">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张鹏的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2017/08/18/programming/java/javastack/javalib/jsoup/" itemprop="url">jsoup 使用小结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-18T00:00:00+08:00">
                2017-08-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/javalib/" itemprop="url" rel="index">
                    <span itemprop="name">javalib</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="jsoup-使用小结"><a href="#jsoup-使用小结" class="headerlink" title="jsoup 使用小结"></a>jsoup 使用小结</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>jsoup 是一款 Java 的 HTML 解析器，可直接解析某个 URL 地址、HTML 文本内容。它提供了一套非常省力的 API，可通过 DOM，CSS 以及类似于 JQuery 的操作方法来取出和操作数据。</p>
<p>jsoup 工作的流程主要如下：</p>
<ol>
<li>从一个 URL，文件或字符串中解析 HTML，并加载为一个 <code>Document</code> 对象。</li>
<li>使用 DOM 或 CSS 选择器来取出数据；</li>
<li>可操作 HTML 元素、属性、文本。</li>
</ol>
<p>jsoup 是基于 MIT 协议发布的，可放心使用于商业项目。</p>
<h2 id="加载"><a href="#加载" class="headerlink" title="加载"></a>加载</h2><h3 id="从HTML字符串加载一个文档"><a href="#从HTML字符串加载一个文档" class="headerlink" title="从HTML字符串加载一个文档"></a>从HTML字符串加载一个文档</h3><p>使用静态 <code>Jsoup.parse(String html)</code> 方法或 <code>Jsoup.parse(String html, String baseUri)</code> 示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String html = <span class="string">"&lt;html&gt;&lt;head&gt;&lt;title&gt;First parse&lt;/title&gt;&lt;/head&gt;"</span></span><br><span class="line">  + <span class="string">"&lt;body&gt;&lt;p&gt;Parsed HTML into a doc.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;"</span>;</span><br><span class="line">Document doc = Jsoup.parse(html);</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>说明</strong></p>
<p><code>parse(String html, String baseUri)</code> 这方法能够将输入的HTML解析为一个新的文档 (Document），参数 baseUri 是用来将相对 URL 转成绝对URL，并指定从哪个网站获取文档。如这个方法不适用，你可以使用 <code>parse(String html)</code> 方法来解析成HTML字符串如上面的示例。</p>
<p>只要解析的不是空字符串，就能返回一个结构合理的文档，其中包含(至少) 一个head和一个body元素。</p>
<p>一旦拥有了一个Document，你就可以使用Document中适当的方法或它父类 <code>Element</code>和<code>Node</code>中的方法来取得相关数据。</p>
</blockquote>
<h3 id="解析一个body片断"><a href="#解析一个body片断" class="headerlink" title="解析一个body片断"></a>解析一个body片断</h3><p><strong>问题</strong></p>
<p>假如你有一个HTML片断 (比如. 一个 <code>div</code> 包含一对 <code>p</code> 标签; 一个不完整的HTML文档) 想对它进行解析。这个HTML片断可以是用户提交的一条评论或在一个CMS页面中编辑body部分。</p>
<p><strong>办法</strong></p>
<p>使用<code>Jsoup.parseBodyFragment(String html)</code>方法.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String html = &quot;&lt;div&gt;&lt;p&gt;Lorem ipsum.&lt;/p&gt;&quot;;</span><br><span class="line">Document doc = Jsoup.parseBodyFragment(html);</span><br><span class="line">Element body = doc.body();</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>说明</strong></p>
<p><code>parseBodyFragment</code> 方法创建一个空壳的文档，并插入解析过的HTML到<code>body</code>元素中。假如你使用正常的 <code>Jsoup.parse(String html)</code> 方法，通常你也可以得到相同的结果，但是明确将用户输入作为 body片段处理，以确保用户所提供的任何糟糕的HTML都将被解析成body元素。</p>
<p><code>Document.body()</code> 方法能够取得文档body元素的所有子元素，与 <code>doc.getElementsByTag(&quot;body&quot;)</code>相同。</p>
</blockquote>
<h4 id="保证安全Stay-safe"><a href="#保证安全Stay-safe" class="headerlink" title="保证安全Stay safe"></a>保证安全Stay safe</h4><p>假如你可以让用户输入HTML内容，那么要小心避免跨站脚本攻击。利用基于 <code>Whitelist</code> 的清除器和 <code>clean(String bodyHtml, Whitelist whitelist)</code>方法来清除用户输入的恶意内容。</p>
<h3 id="从URL加载一个文档"><a href="#从URL加载一个文档" class="headerlink" title="从URL加载一个文档"></a>从URL加载一个文档</h3><p>使用 <code>Jsoup.connect(String url)</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Document doc = Jsoup.connect(<span class="string">"http://example.com/"</span>).get();</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>说明</strong></p>
<p><code>connect(String url)</code> 方法创建一个新的 <code>Connection</code>, 和 <code>get()</code> 取得和解析一个HTML文件。如果从该URL获取HTML时发生错误，便会抛出 IOException，应适当处理。</p>
</blockquote>
<p><code>Connection</code> 接口还提供一个方法链来解决特殊请求，具体如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Document doc = Jsoup.connect(<span class="string">"http://example.com"</span>)</span><br><span class="line">  .data(<span class="string">"query"</span>, <span class="string">"Java"</span>)</span><br><span class="line">  .userAgent(<span class="string">"Mozilla"</span>)</span><br><span class="line">  .cookie(<span class="string">"auth"</span>, <span class="string">"token"</span>)</span><br><span class="line">  .timeout(<span class="number">3000</span>)</span><br><span class="line">  .post();</span><br></pre></td></tr></table></figure>
<h3 id="从一个文件加载一个文档"><a href="#从一个文件加载一个文档" class="headerlink" title="从一个文件加载一个文档"></a>从一个文件加载一个文档</h3><p>可以使用静态 <code>Jsoup.parse(File in, String charsetName, String baseUri)</code> 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">File input = <span class="keyword">new</span> File(<span class="string">"/tmp/input.html"</span>);</span><br><span class="line">Document doc = Jsoup.parse(input, <span class="string">"UTF-8"</span>, <span class="string">"http://example.com/"</span>);</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>说明</strong></p>
<p><code>parse(File in, String charsetName, String baseUri)</code> 这个方法用来加载和解析一个HTML文件。如在加载文件的时候发生错误，将抛出IOException，应作适当处理。</p>
<p><code>baseUri</code> 参数用于解决文件中URLs是相对路径的问题。如果不需要可以传入一个空的字符串。</p>
<p>另外还有一个方法<code>parse(File in, String charsetName)</code> ，它使用文件的路径做为 <code>baseUri</code>。 这个方法适用于如果被解析文件位于网站的本地文件系统，且相关链接也指向该文件系统。</p>
</blockquote>
<h2 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h2><h3 id="使用DOM方法来遍历一个文档"><a href="#使用DOM方法来遍历一个文档" class="headerlink" title="使用DOM方法来遍历一个文档"></a>使用DOM方法来遍历一个文档</h3><p><strong>问题</strong></p>
<p>你有一个HTML文档要从中提取数据，并了解这个HTML文档的结构。</p>
<p><strong>方法</strong></p>
<p>将HTML解析成一个<code>Document</code>之后，就可以使用类似于DOM的方法进行操作。示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">File input = <span class="keyword">new</span> File(<span class="string">"/tmp/input.html"</span>);</span><br><span class="line">Document doc = Jsoup.parse(input, <span class="string">"UTF-8"</span>, <span class="string">"http://example.com/"</span>);</span><br><span class="line"></span><br><span class="line">Element content = doc.getElementById(<span class="string">"content"</span>);</span><br><span class="line">Elements links = content.getElementsByTag(<span class="string">"a"</span>);</span><br><span class="line"><span class="keyword">for</span> (Element link : links) &#123;</span><br><span class="line">  String linkHref = link.attr(<span class="string">"href"</span>);</span><br><span class="line">  String linkText = link.text();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>说明</strong></p>
<p><code>Elements</code> 这个对象提供了一系列类似于 DOM 的方法来查找元素，抽取并处理其中的数据。</p>
<p>具体如下：</p>
<p>####查找元素</p>
<ul>
<li><code>getElementById(String id)</code></li>
<li><code>getElementsByTag(String tag)</code></li>
<li><code>getElementsByClass(String className)</code></li>
<li><code>getElementsByAttribute(String key)</code> (and related methods)</li>
<li>Element siblings: <code>siblingElements()</code>, <code>firstElementSibling()</code>, <code>lastElementSibling()</code>;<code>nextElementSibling()</code>, <code>previousElementSibling()</code></li>
<li>Graph: <code>parent()</code>, <code>children()</code>, <code>child(int index)</code></li>
</ul>
<p>####元素数据</p>
<ul>
<li><code>attr(String key)</code>获取属性<code>attr(String key, String value)</code>设置属性</li>
<li><code>attributes()</code>获取所有属性</li>
<li><code>id()</code>, <code>className()</code> and <code>classNames()</code></li>
<li><code>text()</code>获取文本内容<code>text(String value)</code> 设置文本内容</li>
<li><code>html()</code>获取元素内HTML<code>html(String value)</code>设置元素内的HTML内容</li>
<li><code>outerHtml()</code>获取元素外HTML内容</li>
<li><code>data()</code>获取数据内容（例如：script和style标签)</li>
<li><code>tag()</code> and <code>tagName()</code></li>
</ul>
<p>####操作HTML和文本</p>
<ul>
<li><code>append(String html)</code>, <code>prepend(String html)</code></li>
<li><code>appendText(String text)</code>, <code>prependText(String text)</code></li>
<li><code>appendElement(String tagName)</code>, <code>prependElement(String tagName)</code></li>
<li><code>html(String value)</code></li>
</ul>
<h3 id="使用选择器语法来查找元素"><a href="#使用选择器语法来查找元素" class="headerlink" title="使用选择器语法来查找元素"></a>使用选择器语法来查找元素</h3><p><strong>问题</strong></p>
<p>你想使用类似于CSS或jQuery的语法来查找和操作元素。</p>
<p><strong>方法</strong></p>
<p>可以使用<code>Element.select(String selector)</code> 和 <code>Elements.select(String selector)</code> 方法实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">File input = <span class="keyword">new</span> File(<span class="string">"/tmp/input.html"</span>);</span><br><span class="line">Document doc = Jsoup.parse(input, <span class="string">"UTF-8"</span>, <span class="string">"http://example.com/"</span>);</span><br><span class="line"></span><br><span class="line">Elements links = doc.select(<span class="string">"a[href]"</span>); <span class="comment">//带有href属性的a元素</span></span><br><span class="line">Elements pngs = doc.select(<span class="string">"img[src$=.png]"</span>);</span><br><span class="line">  <span class="comment">//扩展名为.png的图片</span></span><br><span class="line"></span><br><span class="line">Element masthead = doc.select(<span class="string">"div.masthead"</span>).first();</span><br><span class="line">  <span class="comment">//class等于masthead的div标签</span></span><br><span class="line"></span><br><span class="line">Elements resultLinks = doc.select(<span class="string">"h3.r &gt; a"</span>); <span class="comment">//在h3元素之后的a元素</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>说明</strong></p>
<p>jsoup elements对象支持类似于<a href="http://www.w3.org/TR/2009/PR-css3-selectors-20091215/" target="_blank" rel="noopener">CSS</a> (或<a href="http://jquery.com/" target="_blank" rel="noopener">jquery</a>)的选择器语法，来实现非常强大和灵活的查找功能。.</p>
<p>这个<code>select</code> 方法在<code>Document</code>, <code>Element</code>,或<code>Elements</code>对象中都可以使用。且是上下文相关的，因此可实现指定元素的过滤，或者链式选择访问。</p>
<p>Select方法将返回一个<code>Elements</code>集合，并提供一组方法来抽取和处理结果。</p>
</blockquote>
<p>####Selector选择器概述</p>
<ul>
<li><code>tagname</code>: 通过标签查找元素，比如：<code>a</code></li>
<li><code>ns|tag</code>: 通过标签在命名空间查找元素，比如：可以用 <code>fb|name</code> 语法来查找 <code></code> 元素</li>
<li><code>#id</code>: 通过ID查找元素，比如：<code>#logo</code></li>
<li><code>.class</code>: 通过class名称查找元素，比如：<code>.masthead</code></li>
<li><code>[attribute]</code>: 利用属性查找元素，比如：<code>[href]</code></li>
<li><code>[^attr]</code>: 利用属性名前缀来查找元素，比如：可以用<code>[^data-]</code> 来查找带有HTML5 Dataset属性的元素</li>
<li><code>[attr=value]</code>: 利用属性值来查找元素，比如：<code>[width=500]</code></li>
<li><code>[attr^=value]</code>, <code>[attr$=value]</code>, <code>[attr*=value]</code>: 利用匹配属性值开头、结尾或包含属性值来查找元素，比如：<code>[href*=/path/]</code></li>
<li><code>[attr\~=regex]</code>: 利用属性值匹配正则表达式来查找元素，比如： <code>img[src\~=(?i)\.(png|jpe?g)]</code></li>
<li><code>*</code>: 这个符号将匹配所有元素</li>
</ul>
<p>####Selector选择器组合使用</p>
<ul>
<li><code>el##id</code>: 元素+ID，比如： <code>div##logo</code></li>
<li><code>el.class</code>: 元素+class，比如： <code>div.masthead</code></li>
<li><code>el[attr]</code>: 元素+class，比如： <code>a[href]</code></li>
<li>任意组合，比如：<code>a[href].highlight</code></li>
<li><code>ancestor child</code>: 查找某个元素下子元素，比如：可以用<code>.body p</code> 查找在”body”元素下的所有<code>p</code>元素</li>
<li><code>parent &gt; child</code>: 查找某个父元素下的直接子元素，比如：可以用<code>div.content &gt; p</code> 查找 <code>p</code> 元素，也可以用<code>body &gt; *</code> 查找body标签下所有直接子元素</li>
<li><code>siblingA + siblingB</code>: 查找在A元素之前第一个同级元素B，比如：<code>div.head + div</code></li>
<li><code>siblingA \~ siblingX</code>: 查找A元素之前的同级X元素，比如：<code>h1 \~ p</code></li>
<li><code>el, el, el</code>:多个选择器组合，查找匹配任一选择器的唯一元素，例如：<code>div.masthead, div.logo</code></li>
</ul>
<p>####伪选择器selectors</p>
<ul>
<li><code>:lt(n)</code>: 查找哪些元素的同级索引值（它的位置在DOM树中是相对于它的父节点）小于n，比如：<code>td:lt(3)</code> 表示小于三列的元素</li>
<li><code>:gt(n)</code>:查找哪些元素的同级索引值大于<code>n`</code>，比如<code>：</code>div p:gt(2)`表示哪些div中有包含2个以上的p元素</li>
<li><code>:eq(n)</code>: 查找哪些元素的同级索引值与<code>n</code>相等，比如：<code>form input:eq(1)</code>表示包含一个input标签的Form元素</li>
<li><code>:has(seletor)</code>: 查找匹配选择器包含元素的元素，比如：<code>div:has(p)</code>表示哪些div包含了p元素</li>
<li><code>:not(selector)</code>: 查找与选择器不匹配的元素，比如： <code>div:not(.logo)</code> 表示不包含 class=logo 元素的所有 div 列表</li>
<li><code>:contains(text)</code>: 查找包含给定文本的元素，搜索不区分大不写，比如： <code>p:contains(jsoup)</code></li>
<li><code>:containsOwn(text)</code>: 查找直接包含给定文本的元素</li>
<li><code>:matches(regex)</code>: 查找哪些元素的文本匹配指定的正则表达式，比如：<code>div:matches((?i)login)</code></li>
<li><code>:matchesOwn(regex)</code>: 查找自身包含文本匹配指定正则表达式的元素</li>
<li>注意：上述伪选择器索引是从0开始的，也就是说第一个元素索引值为0，第二个元素index为1等</li>
</ul>
<p>可以查看<code>Selector</code> API参考来了解更详细的内容</p>
<h3 id="从元素抽取属性，文本和HTML"><a href="#从元素抽取属性，文本和HTML" class="headerlink" title="从元素抽取属性，文本和HTML"></a>从元素抽取属性，文本和HTML</h3><p><strong>问题</strong></p>
<p>在解析获得一个Document实例对象，并查找到一些元素之后，你希望取得在这些元素中的数据。</p>
<p><strong>方法</strong></p>
<ul>
<li>要取得一个属性的值，可以使用<code>Node.attr(String key)</code> 方法</li>
<li>对于一个元素中的文本，可以使用<code>Element.text()</code>方法</li>
<li>对于要取得元素或属性中的HTML内容，可以使用<code>Element.html()</code>, 或 <code>Node.outerHtml()</code>方法</li>
</ul>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">String html = <span class="string">"&lt;p&gt;An &lt;a href='http://example.com/'&gt;&lt;b&gt;example&lt;/b&gt;&lt;/a&gt; link.&lt;/p&gt;"</span>;</span><br><span class="line">Document doc = Jsoup.parse(html);<span class="comment">//解析HTML字符串返回一个Document实现</span></span><br><span class="line">Element link = doc.select(<span class="string">"a"</span>).first();<span class="comment">//查找第一个a元素</span></span><br><span class="line"></span><br><span class="line">String text = doc.body().text(); <span class="comment">// "An example link"//取得字符串中的文本</span></span><br><span class="line">String linkHref = link.attr(<span class="string">"href"</span>); <span class="comment">// "http://example.com/"//取得链接地址</span></span><br><span class="line">String linkText = link.text(); <span class="comment">// "example""//取得链接地址中的文本</span></span><br><span class="line"></span><br><span class="line">String linkOuterH = link.outerHtml(); </span><br><span class="line">    <span class="comment">// "&lt;a href="http://example.com"&gt;&lt;b&gt;example&lt;/b&gt;&lt;/a&gt;"</span></span><br><span class="line">String linkInnerH = link.html(); <span class="comment">// "&lt;b&gt;example&lt;/b&gt;"//取得链接内的html内容</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>说明</strong></p>
<p>上述方法是元素数据访问的核心办法。此外还其它一些方法可以使用：</p>
<ul>
<li><code>Element.id()</code></li>
<li><code>Element.tagName()</code></li>
<li><code>Element.className()</code> and <code>Element.hasClass(String className)</code></li>
</ul>
<p>这些访问器方法都有相应的setter方法来更改数据</p>
</blockquote>
<p><strong>参见</strong></p>
<ul>
<li><code>Element</code>和<code>Elements</code>集合类的参考文档</li>
<li><a href="http://www.open-open.com/jsoup/working-with-urls.htm" target="_blank" rel="noopener">URLs处理</a></li>
<li><a href="http://www.open-open.com/jsoup/selector-syntax.htm" target="_blank" rel="noopener">使用CSS选择器语法来查找元素</a></li>
</ul>
<h3 id="处理URLs"><a href="#处理URLs" class="headerlink" title="处理URLs"></a>处理URLs</h3><p><strong>问题</strong></p>
<p>你有一个包含相对URLs路径的HTML文档，需要将这些相对路径转换成绝对路径的URLs。</p>
<p><strong>方法</strong></p>
<ol>
<li>在你解析文档时确保有指定<code>base URI</code>，然后</li>
<li>使用 <code>abs:</code> 属性前缀来取得包含<code>base URI</code>的绝对路径。代码如下： </li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Document doc = Jsoup.connect(<span class="string">"http://www.open-open.com"</span>).get();</span><br><span class="line"></span><br><span class="line">Element link = doc.select(<span class="string">"a"</span>).first();</span><br><span class="line">String relHref = link.attr(<span class="string">"href"</span>); <span class="comment">// == "/"</span></span><br><span class="line">String absHref = link.attr(<span class="string">"abs:href"</span>); <span class="comment">// "http://www.open-open.com/"</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>说明</strong></p>
<p>在HTML元素中，URLs 经常写成相对于文档位置的相对路径： <code>&lt;a href=&quot;/download&quot;&gt;...&lt;/a&gt;</code>. 当你使用 <code>Node.attr(String key)</code> 方法来取得a元素的href属性时，它将直接返回在HTML源码中指定定的值。</p>
<p>假如你需要取得一个绝对路径，需要在属性名前加 <code>abs:</code> 前缀。这样就可以返回包含根路径的URL地址<code>attr(&quot;abs:href&quot;)</code></p>
<p>因此，在解析HTML文档时，定义base URI非常重要。</p>
<p>如果你不想使用<code>abs:</code> 前缀，还有一个方法能够实现同样的功能 <code>Node.absUrl(String key)</code>。</p>
</blockquote>
<h2 id="数据修改"><a href="#数据修改" class="headerlink" title="数据修改"></a>数据修改</h2><h3 id="设置属性的值"><a href="#设置属性的值" class="headerlink" title="设置属性的值"></a>设置属性的值</h3><p><strong>问题</strong></p>
<p>在你解析一个 <code>Document</code> 之后可能想修改其中的某些属性值，然后再保存到磁盘或都输出到前台页面。</p>
<p><strong>方法</strong></p>
<p>可以使用属性设置方法 <code>Element.attr(String key, String value)</code>, 和 <code>Elements.attr(String key, String value)</code>.</p>
<p>假如你需要修改一个元素的 <code>class</code> 属性，可以使用 <code>Element.addClass(String className)</code> 和<code>Element.removeClass(String className)</code> 方法。</p>
<p><code>Elements</code> 提供了批量操作元素属性和class的方法，比如：要为div中的每一个a元素都添加一个<code>rel=&quot;nofollow&quot;</code> 可以使用如下方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">doc.select(&quot;div.comments a&quot;).attr(&quot;rel&quot;, &quot;nofollow&quot;);</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>说明</strong></p>
<p>与<code>Element</code>中的其它方法一样，<code>attr</code> 方法也是返回当 <code>Element</code> (或在使用选择器是返回 <code>Elements</code>集合)。这样能够很方便使用方法连用的书写方式。比如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; doc.select(&quot;div.masthead&quot;).attr(&quot;title&quot;, &quot;jsoup&quot;).addClass(&quot;round-box&quot;);</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
</blockquote>
<h3 id="设置一个元素的HTML内容"><a href="#设置一个元素的HTML内容" class="headerlink" title="设置一个元素的HTML内容"></a>设置一个元素的HTML内容</h3><p><strong>问题</strong></p>
<p>你需要一个元素中的HTML内容</p>
<p><strong>方法</strong></p>
<p>可以使用<code>Element</code>中的HTML设置方法具体如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Element div = doc.select(<span class="string">"div"</span>).first(); <span class="comment">// &lt;div&gt;&lt;/div&gt;</span></span><br><span class="line">div.html(<span class="string">"&lt;p&gt;lorem ipsum&lt;/p&gt;"</span>); <span class="comment">// &lt;div&gt;&lt;p&gt;lorem ipsum&lt;/p&gt;&lt;/div&gt;</span></span><br><span class="line">div.prepend(<span class="string">"&lt;p&gt;First&lt;/p&gt;"</span>);<span class="comment">//在div前添加html内容</span></span><br><span class="line">div.append(<span class="string">"&lt;p&gt;Last&lt;/p&gt;"</span>);<span class="comment">//在div之后添加html内容</span></span><br><span class="line"><span class="comment">// 添完后的结果: &lt;div&gt;&lt;p&gt;First&lt;/p&gt;&lt;p&gt;lorem ipsum&lt;/p&gt;&lt;p&gt;Last&lt;/p&gt;&lt;/div&gt;</span></span><br><span class="line"></span><br><span class="line">Element span = doc.select(<span class="string">"span"</span>).first(); <span class="comment">// &lt;span&gt;One&lt;/span&gt;</span></span><br><span class="line">span.wrap(<span class="string">"&lt;li&gt;&lt;a href='http://example.com/'&gt;&lt;/a&gt;&lt;/li&gt;"</span>);</span><br><span class="line"><span class="comment">// 添完后的结果: &lt;li&gt;&lt;a href="http://example.com"&gt;&lt;span&gt;One&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>说明</strong></p>
<ul>
<li><code>Element.html(String html)</code> 这个方法将先清除元素中的HTML内容，然后用传入的HTML代替。</li>
<li><code>Element.prepend(String first)</code> 和 <code>Element.append(String last)</code> 方法用于在分别在元素内部HTML的前面和后面添加HTML内容</li>
<li><code>Element.wrap(String around)</code> 对元素包裹一个外部HTML内容。</li>
</ul>
<p><strong>参见</strong></p>
<p>可以查看API参考文档中 <code>Element.prependElement(String tag)</code>和<code>Element.appendElement(String tag)</code> 方法来创建新的元素并作为文档的子元素插入其中。</p>
</blockquote>
<h3 id="设置元素的文本内容"><a href="#设置元素的文本内容" class="headerlink" title="设置元素的文本内容"></a>设置元素的文本内容</h3><p><strong>问题</strong></p>
<p>你需要修改一个HTML文档中的文本内容</p>
<p><strong>方法</strong></p>
<p>可以使用<code>Element</code>的设置方法：:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Element div = doc.select(&quot;div&quot;).first(); // &lt;div&gt;&lt;/div&gt;</span><br><span class="line">div.text(&quot;five &gt; four&quot;); // &lt;div&gt;five &amp;gt; four&lt;/div&gt;</span><br><span class="line">div.prepend(&quot;First &quot;);</span><br><span class="line">div.append(&quot; Last&quot;);</span><br><span class="line">// now: &lt;div&gt;First five &amp;gt; four Last&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>说明</strong></p>
<p>文本设置方法与 <a href="http://jsoup.org/cookbook/modifying-data/set-html" target="_blank" rel="noopener">HTML setter</a> 方法一样：</p>
<ul>
<li><code>Element.text(String text)</code> 将清除一个元素中的内部HTML内容，然后提供的文本进行代替</li>
<li><code>Element.prepend(String first)</code> 和 <code>Element.append(String last)</code> 将分别在元素的内部html前后添加文本节点。</li>
</ul>
<p>对于传入的文本如果含有像 <code>&lt;</code>, <code>&gt;</code> 等这样的字符，将以文本处理，而非HTML。</p>
</blockquote>
<h2 id="HTML清理"><a href="#HTML清理" class="headerlink" title="HTML清理"></a>HTML清理</h2><h3 id="消除不受信任的HTML-来防止XSS攻击"><a href="#消除不受信任的HTML-来防止XSS攻击" class="headerlink" title="消除不受信任的HTML (来防止XSS攻击)"></a>消除不受信任的HTML (来防止XSS攻击)</h3><p><strong>问题</strong></p>
<p>在做网站的时候，经常会提供用户评论的功能。有些不怀好意的用户，会搞一些脚本到评论内容中，而这些脚本可能会破坏整个页面的行为，更严重的是获取一些机要信息，此时需要清理该HTML，以避免跨站脚本<a href="http://en.wikipedia.org/wiki/Cross-site_scripting" target="_blank" rel="noopener">cross-site scripting</a>攻击（XSS）。</p>
<p><strong>方法</strong></p>
<p>使用jsoup HTML <code>Cleaner</code> 方法进行清除，但需要指定一个可配置的 <code>Whitelist</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String unsafe = </span><br><span class="line">  <span class="string">"&lt;p&gt;&lt;a href='http://example.com/' onclick='stealCookies()'&gt;Link&lt;/a&gt;&lt;/p&gt;"</span>;</span><br><span class="line">String safe = Jsoup.clean(unsafe, Whitelist.basic());</span><br><span class="line"><span class="comment">// now: &lt;p&gt;&lt;a href="http://example.com/" rel="nofollow"&gt;Link&lt;/a&gt;&lt;/p&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>说明</strong></p>
<p>XSS 又叫 CSS (Cross Site Script) ，跨站脚本攻击。它指的是恶意攻击者往 Web 页面里插入恶意 html 代码，当用户浏览该页之时，嵌入其中 Web 里面的 html 代码会被执行，从而达到恶意攻击用户的特殊目的。XSS 属于被动式的攻击，因为其被动且不好利用，所以许多人常忽略其危害性。所以我们经常只让用户输入纯文本的内容，但这样用户体验就比较差了。</p>
<p>一个更好的解决方法就是使用一个富文本编辑器 WYSIWYG 如 <a href="http://ckeditor.com/" target="_blank" rel="noopener">CKEditor</a> 和 <a href="http://tinymce.moxiecode.com/" target="_blank" rel="noopener">TinyMCE</a>。这些可以输出 HTML 并能够让用户可视化编辑。虽然他们可以在客户端进行校验，但是这样还不够安全，需要在服务器端进行校验并清除有害的HTML代码，这样才能确保输入到你网站的HTML是安全的。否则，攻击者能够绕过客户端的 Javascript 验证，并注入不安全的 HMTL 直接进入您的网站。</p>
<p>jsoup 的 whitelist 清理器能够在服务器端对用户输入的 HTML 进行过滤，只输出一些安全的标签和属性。</p>
<p>jsoup 提供了一系列的 <code>Whitelist</code> 基本配置，能够满足大多数要求；但如有必要，也可以进行修改，不过要小心。</p>
<p>这个 cleaner 非常好用不仅可以避免 XSS 攻击，还可以限制用户可以输入的标签范围。</p>
<p><strong>参见</strong></p>
<ul>
<li>参阅<a href="http://ha.ckers.org/xss.html" target="_blank" rel="noopener">XSS cheat sheet</a> ，有一个例子可以了解为什么不能使用正则表达式，而采用安全的whitelist parser-based清理器才是正确的选择。</li>
<li>参阅<code>Cleaner</code> ，了解如何返回一个 <code>Document</code> 对象，而不是字符串</li>
<li>参阅<code>Whitelist</code>，了解如何创建一个自定义的whitelist</li>
<li><a href="http://en.wikipedia.org/wiki/Nofollow" target="_blank" rel="noopener">nofollow</a> 链接属性了解</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><p><a href="https://github.com/jhy/jsoup" target="_blank" rel="noopener">jsoup github托管代码</a></p>
</li>
<li><p><a href="https://jsoup.org/cookbook/" target="_blank" rel="noopener">jsoup Cookbook</a></p>
</li>
<li><p><a href="http://www.open-open.com/jsoup/" target="_blank" rel="noopener">jsoup Cookbook(中文版)</a></p>
</li>
<li><p><a href="https://github.com/code4craft/jsoup-learning" target="_blank" rel="noopener">不错的jsoup学习笔记</a></p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/blog/2017/01/17/programming/java/javastack/javalib/thumbnailator/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhang Peng">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张鹏的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2017/01/17/programming/java/javastack/javalib/thumbnailator/" itemprop="url">Thumbnailator 使用小结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-01-17T00:00:00+08:00">
                2017-01-17
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/javalib/" itemprop="url" rel="index">
                    <span itemprop="name">javalib</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Thumbnailator-使用小结"><a href="#Thumbnailator-使用小结" class="headerlink" title="Thumbnailator 使用小结"></a>Thumbnailator 使用小结</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p><code>Thumbnailator</code> 是一个开源的 <strong>Java</strong> 项目，它提供了非常简单的 API 来对图片进行缩放、旋转以及加水印的处理。</p>
<p>有多简单呢？简单到一行代码就可以完成图片处理。形式如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Thumbnails.of(<span class="keyword">new</span> File(<span class="string">"path/to/directory"</span>).listFiles())</span><br><span class="line">    .size(<span class="number">640</span>, <span class="number">480</span>)</span><br><span class="line">    .outputFormat(<span class="string">"jpg"</span>)</span><br><span class="line">    .toFiles(Rename.PREFIX_DOT_THUMBNAIL);</span><br></pre></td></tr></table></figure>
<p>当然，Thumbnailator 还有一些使用细节，下面我会一一道来。</p>
<h2 id="核心-API"><a href="#核心-API" class="headerlink" title="核心 API"></a>核心 API</h2><h3 id="Thumbnails"><a href="#Thumbnails" class="headerlink" title="Thumbnails"></a>Thumbnails</h3><p><code>Thumbnails</code> 是使用 Thumbnailator 创建缩略图的主入口。</p>
<p>它提供了一组初始化 <code>Thumbnails.Builder</code> 的接口。</p>
<p>先看下这组接口的声明：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 可变长度参数列表</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Builder&lt;File&gt; <span class="title">of</span><span class="params">(String... files)</span> </span>&#123;...&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Builder&lt;File&gt; <span class="title">of</span><span class="params">(File... files)</span> </span>&#123;...&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Builder&lt;URL&gt; <span class="title">of</span><span class="params">(URL... urls)</span> </span>&#123;...&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Builder&lt;? extends InputStream&gt; of(InputStream... inputStreams) &#123;...&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Builder&lt;BufferedImage&gt; <span class="title">of</span><span class="params">(BufferedImage... images)</span> </span>&#123;...&#125;</span><br><span class="line"><span class="comment">// 迭代器（所有实现 Iterable 接口的 Java 对象都可以，当然也包括 List、Set）</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Builder&lt;File&gt; <span class="title">fromFilenames</span><span class="params">(Iterable&lt;String&gt; files)</span> </span>&#123;...&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Builder&lt;File&gt; <span class="title">fromFiles</span><span class="params">(Iterable&lt;File&gt; files)</span> </span>&#123;...&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Builder&lt;URL&gt; <span class="title">fromURLs</span><span class="params">(Iterable&lt;URL&gt; urls)</span> </span>&#123;...&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Builder&lt;InputStream&gt; <span class="title">fromInputStreams</span><span class="params">(Iterable&lt;? extends InputStream&gt; inputStreams)</span> </span>&#123;...&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Builder&lt;BufferedImage&gt; <span class="title">fromImages</span><span class="params">(Iterable&lt;BufferedImage&gt; images)</span> </span>&#123;...&#125;</span><br></pre></td></tr></table></figure>
<p>很显然，<strong>Thumbnails 允许通过传入文件名、文件、网络图的URL、图片流、图片缓存多种方式来初始化构造器</strong>。</p>
<p>因此，你可以根据实际需求来灵活的选择图片的输入方式。</p>
<p>需要注意一点：<strong>如果输入是多个对象（无论你是直接输入容器对象或使用可变参数方式传入多个对象），则输出也必须选用输出多个对象的方式，否则会报异常。</strong></p>
<h3 id="Thumbnails-Builder"><a href="#Thumbnails-Builder" class="headerlink" title="Thumbnails.Builder"></a>Thumbnails.Builder</h3><p><code>Thumbnails.Builder</code> 是 <code>Thumbnails</code> 的内部静态类。它用于设置生成缩略图任务的相关参数。</p>
<p><strong><em>注：<code>Thumbnails.Builder</code> 的构造函数是私有函数。所以，它只允许通过 <code>Thumbnails</code> 的实例化函数来进行初始化。</em></strong></p>
<h4 id="设置参数的函数"><a href="#设置参数的函数" class="headerlink" title="设置参数的函数"></a>设置参数的函数</h4><p><code>Thumbnails.Builder</code> 提供了一组函数链形式的接口来设置缩放图参数。</p>
<p>以设置大小函数为例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Builder&lt;T&gt; <span class="title">size</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	updateStatus(Properties.SIZE, Status.ALREADY_SET);</span><br><span class="line">	updateStatus(Properties.SCALE, Status.CANNOT_SET);</span><br><span class="line">	</span><br><span class="line">	validateDimensions(width, height);</span><br><span class="line">	<span class="keyword">this</span>.width = width;</span><br><span class="line">	<span class="keyword">this</span>.height = height;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过返回this指针，使得设置参数函数可以以链式调用的方式来使用，形式如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Thumbnails.of(<span class="keyword">new</span> File(<span class="string">"original.jpg"</span>))</span><br><span class="line">        .size(<span class="number">160</span>, <span class="number">160</span>)</span><br><span class="line">        .rotate(<span class="number">90</span>)</span><br><span class="line">        .watermark(Positions.BOTTOM_RIGHT, ImageIO.read(<span class="keyword">new</span> File(<span class="string">"watermark.png"</span>)), <span class="number">0.5f</span>)</span><br><span class="line">        .outputQuality(<span class="number">0.8</span>)</span><br><span class="line">        .toFile(<span class="keyword">new</span> File(<span class="string">"image-with-watermark.jpg"</span>));</span><br></pre></td></tr></table></figure>
<p>好处，不言自明：那就是大大简化了代码。</p>
<h4 id="输出函数"><a href="#输出函数" class="headerlink" title="输出函数"></a>输出函数</h4><p><code>Thumbnails.Builder</code> 提供了一组重载函数来输出生成的缩放图。</p>
<p>函数声明如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回图片缓存</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;BufferedImage&gt; <span class="title">asBufferedImages</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;...&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> BufferedImage <span class="title">asBufferedImage</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;...&#125;</span><br><span class="line"><span class="comment">// 返回文件列表</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;File&gt; <span class="title">asFiles</span><span class="params">(Iterable&lt;File&gt; iterable)</span> <span class="keyword">throws</span> IOException </span>&#123;...&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;File&gt; <span class="title">asFiles</span><span class="params">(Rename rename)</span> <span class="keyword">throws</span> IOException </span>&#123;...&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;File&gt; <span class="title">asFiles</span><span class="params">(File destinationDir, Rename rename)</span> <span class="keyword">throws</span> IOException </span>&#123;...&#125;</span><br><span class="line"><span class="comment">// 创建文件</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">toFile</span><span class="params">(File outFile)</span> <span class="keyword">throws</span> IOException </span>&#123;...&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">toFile</span><span class="params">(String outFilepath)</span> <span class="keyword">throws</span> IOException </span>&#123;...&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">toFiles</span><span class="params">(Iterable&lt;File&gt; iterable)</span> <span class="keyword">throws</span> IOException </span>&#123;...&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">toFiles</span><span class="params">(Rename rename)</span> <span class="keyword">throws</span> IOException </span>&#123;...&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">toFiles</span><span class="params">(File destinationDir, Rename rename)</span> <span class="keyword">throws</span> IOException </span>&#123;...&#125;</span><br><span class="line"><span class="comment">// 创建输出流</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">toOutputStream</span><span class="params">(OutputStream os)</span> <span class="keyword">throws</span> IOException </span>&#123;...&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">toOutputStreams</span><span class="params">(Iterable&lt;? extends OutputStream&gt; iterable)</span> <span class="keyword">throws</span> IOException </span>&#123;...&#125;</span><br></pre></td></tr></table></figure>
<h3 id="工作流"><a href="#工作流" class="headerlink" title="工作流"></a>工作流</h3><p>Thumbnailator 的工作步骤十分简单，可分为三步：</p>
<ol>
<li><p><strong>输入</strong>：<code>Thumbnails</code> 根据输入初始化构造器—— <code>Thumbnails.Builder</code> 。</p>
</li>
<li><p><strong>设置</strong>：<code>Thumbnails.Builder</code> 设置缩放图片的参数。</p>
</li>
<li><p><strong>输出</strong>：<code>Thumbnails.Builder</code> 输出图片文件或图片流。</p>
</li>
</ol>
<blockquote>
<p>更多详情可以参考： <a href="https://coobird.github.io/thumbnailator/javadoc/0.4.8/" target="_blank" rel="noopener"><u>Thumbnailator 官网javadoc</u></a></p>
</blockquote>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><p>前文介绍了 Thumbnailator 的核心 API，接下来我们就可以通过实战来看看 Thumbnailator 究竟可以做些什么。</p>
<p>Thumbnailator 生成什么样的图片，是根据设置参数来决定的。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>maven项目中引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.coobird<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>thumbnailator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>[0.4, 0.5)<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="图片缩放"><a href="#图片缩放" class="headerlink" title="图片缩放"></a>图片缩放</h3><p><code>Thumbnails.Builder</code> 的 <code>size</code> 函数可以设置新图片精确的宽度和高度，也可以用 <code>scale</code> 函数设置缩放比例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Thumbnails.of(<span class="string">"oldFile.png"</span>)</span><br><span class="line">		.size(<span class="number">16</span>, <span class="number">16</span>)</span><br><span class="line">		.toFile(<span class="string">"newFile_16_16.png"</span>);</span><br><span class="line"></span><br><span class="line">Thumbnails.of(<span class="string">"oldFile.png"</span>)</span><br><span class="line">		.scale(<span class="number">2.0</span>)</span><br><span class="line">		.toFile(<span class="string">"newFile_scale_2.0.png"</span>);</span><br><span class="line"></span><br><span class="line">Thumbnails.of(<span class="string">"oldFile.png"</span>)</span><br><span class="line">		.scale(<span class="number">1.0</span>, <span class="number">0.5</span>)</span><br><span class="line">		.toFile(<span class="string">"newFile_scale_1.0_0.5.png"</span>);</span><br></pre></td></tr></table></figure>
<p><strong>oldFile.png</strong><br><br><div align="center"><img src="http://upload-images.jianshu.io/upload_images/3101171-ba63439898602e8f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></div><br></p>
<p><strong>newFile_scale_1.0_0.5.png</strong><br><br><div align="center"><img src="http://upload-images.jianshu.io/upload_images/3101171-a01ea4515fff865d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></div><br></p>
<h3 id="图片旋转"><a href="#图片旋转" class="headerlink" title="图片旋转"></a>图片旋转</h3><p><code>Thumbnails.Builder</code> 的 <code>size</code> 函数可以设置新图片的旋转角度。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Thumbnails.of(<span class="string">"oldFile.png"</span>)</span><br><span class="line">		.scale(<span class="number">0.8</span>)</span><br><span class="line">		.rotate(<span class="number">90</span>)</span><br><span class="line">		.toFile(<span class="string">"newFile_rotate_90.png"</span>);</span><br><span class="line"></span><br><span class="line">Thumbnails.of(<span class="string">"oldFile.png"</span>)</span><br><span class="line">		.scale(<span class="number">0.8</span>)</span><br><span class="line">		.rotate(<span class="number">180</span>)</span><br><span class="line">		.toFile(<span class="string">"newFile_rotate_180.png"</span>);</span><br></pre></td></tr></table></figure>
<p><strong>newFile_rotate_90.png</strong></p>
<p><br><div align="center"><img src="http://upload-images.jianshu.io/upload_images/3101171-17d54bc33b38d45b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></div><br></p>
<h3 id="加水印"><a href="#加水印" class="headerlink" title="加水印"></a>加水印</h3><p><code>Thumbnails.Builder</code> 的 <code>watermark</code> 函数可以为图片添加水印图片。第一个参数是水印的位置；第二个参数是水印图片的缓存数据；第三个参数是透明度。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">BufferedImage watermarkImage = ImageIO.read(<span class="keyword">new</span> File(<span class="string">"wartermarkFile.png"</span>));</span><br><span class="line">Thumbnails.of(<span class="string">"oldFile.png"</span>)</span><br><span class="line">		.scale(<span class="number">0.8</span>)</span><br><span class="line">		.watermark(Positions.BOTTOM_LEFT, watermarkImage, <span class="number">0.5f</span>)</span><br><span class="line">		.toFile(<span class="string">"newFile_watermark.png"</span>);</span><br></pre></td></tr></table></figure>
<p><strong>wartermarkFile.png</strong></p>
<p><br><div align="center"><img src="http://upload-images.jianshu.io/upload_images/3101171-97909ee6c066c195.png?imageMogr2/auto-orient/strip"></div><br></p>
<p><strong>newFile_watermark.png</strong></p>
<p><br><div align="center"><img src="http://upload-images.jianshu.io/upload_images/3101171-93eb7ef71b811a0c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></div><br></p>
<h3 id="批量处理图片"><a href="#批量处理图片" class="headerlink" title="批量处理图片"></a>批量处理图片</h3><p>下面以批量给图片加水印来展示一下如何处理多个图片文件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">BufferedImage watermarkImage = ImageIO.read(<span class="keyword">new</span> File(<span class="string">"wartermarkFile.png"</span>));</span><br><span class="line"></span><br><span class="line">File destinationDir = <span class="keyword">new</span> File(<span class="string">"D:\\watermark\\"</span>);</span><br><span class="line">Thumbnails.of(<span class="string">"oldFile.png"</span>, <span class="string">"oldFile2.png"</span>)</span><br><span class="line">		.scale(<span class="number">0.8</span>)</span><br><span class="line">		.watermark(Positions.BOTTOM_LEFT, watermarkImage, <span class="number">0.5f</span>)</span><br><span class="line">		.toFiles(destinationDir, Rename.PREFIX_DOT_THUMBNAIL);</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>需要参考完整测试例代码请</strong> <a href="https://github.com/dunwu/JavaParty/blob/master/toolbox/image/src/test/java/org/zp/image/ThumbnailatorTest.java" target="_blank" rel="noopener"><u><strong>点击这里</strong></u></a></p>
</blockquote>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://github.com/coobird/thumbnailator/wiki/Examples" target="_blank" rel="noopener">Thumbnailator 官方示例文档</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/blog/2017/01/17/programming/java/javastack/javalib/zxing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhang Peng">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/blog/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="张鹏的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/blog/2017/01/17/programming/java/javastack/javalib/zxing/" itemprop="url">ZXing 使用小结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-01-17T00:00:00+08:00">
                2017-01-17
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/blog/categories/javalib/" itemprop="url" rel="index">
                    <span itemprop="name">javalib</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ZXing-使用小结"><a href="#ZXing-使用小结" class="headerlink" title="ZXing 使用小结"></a>ZXing 使用小结</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p><code>ZXing</code> 是一个开源 Java 类库用于解析多种格式的 1D/2D 条形码。目标是能够对QR编码、Data Matrix、UPC的1D条形码进行解码。 其提供了多种平台下的客户端包括：J2ME、J2SE和Android。 </p>
<p>官网：<a href="https://github.com/zxing/zxing" target="_blank" rel="noopener"><u>ZXing github仓库</u></a></p>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><p><strong><em>本例演示如何在一个非 android 的 Java 项目中使用 ZXing 来生成、解析二维码图片。</em></strong></p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>maven项目只需引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.zxing<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.zxing<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javase<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>如果非maven项目，就去官网下载发布版本：<a href="https://github.com/zxing/zxing/releases" target="_blank" rel="noopener"><u>下载地址</u></a></p>
<h3 id="生成二维码图片"><a href="#生成二维码图片" class="headerlink" title="生成二维码图片"></a>生成二维码图片</h3><p>ZXing 生成二维码图片有以下步骤：</p>
<ol>
<li><code>com.google.zxing.MultiFormatWriter</code> 根据内容以及图像编码参数生成图像2D矩阵。</li>
<li>​ <code>com.google.zxing.client.j2se.MatrixToImageWriter</code> 根据图像矩阵生成图片文件或图片缓存 <code>BufferedImage</code> 。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(String content, String filepath)</span> <span class="keyword">throws</span> WriterException, IOException </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> width = <span class="number">100</span>;</span><br><span class="line">	<span class="keyword">int</span> height = <span class="number">100</span>;</span><br><span class="line">	Map&lt;EncodeHintType, Object&gt; encodeHints = <span class="keyword">new</span> HashMap&lt;EncodeHintType, Object&gt;();</span><br><span class="line">	encodeHints.put(EncodeHintType.CHARACTER_SET, <span class="string">"UTF-8"</span>);</span><br><span class="line">	BitMatrix bitMatrix = <span class="keyword">new</span> MultiFormatWriter().encode(content, BarcodeFormat.QR_CODE, width, height, encodeHints);</span><br><span class="line">	Path path = FileSystems.getDefault().getPath(filepath);</span><br><span class="line">	MatrixToImageWriter.writeToPath(bitMatrix, <span class="string">"png"</span>, path);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="解析二维码图片"><a href="#解析二维码图片" class="headerlink" title="解析二维码图片"></a>解析二维码图片</h3><p>ZXing 解析二维码图片有以下步骤：</p>
<ol>
<li><p>使用 <code>javax.imageio.ImageIO</code> 读取图片文件，并存为一个 <code>java.awt.image.BufferedImage</code> 对象。</p>
</li>
<li><p>将 <code>java.awt.image.BufferedImage</code> 转换为 ZXing 能识别的 <code>com.google.zxing.BinaryBitmap</code> 对象。</p>
</li>
<li><p><code>com.google.zxing.MultiFormatReader</code> 根据图像解码参数来解析 <code>com.google.zxing.BinaryBitmap</code> 。</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">decode</span><span class="params">(String filepath)</span> <span class="keyword">throws</span> IOException, NotFoundException </span>&#123;</span><br><span class="line">	BufferedImage bufferedImage = ImageIO.read(<span class="keyword">new</span> FileInputStream(filepath));</span><br><span class="line">	LuminanceSource source = <span class="keyword">new</span> BufferedImageLuminanceSource(bufferedImage);</span><br><span class="line">	Binarizer binarizer = <span class="keyword">new</span> HybridBinarizer(source);</span><br><span class="line">	BinaryBitmap bitmap = <span class="keyword">new</span> BinaryBitmap(binarizer);</span><br><span class="line">	HashMap&lt;DecodeHintType, Object&gt; decodeHints = <span class="keyword">new</span> HashMap&lt;DecodeHintType, Object&gt;();</span><br><span class="line">	decodeHints.put(DecodeHintType.CHARACTER_SET, <span class="string">"UTF-8"</span>);</span><br><span class="line">	Result result = <span class="keyword">new</span> MultiFormatReader().decode(bitmap, decodeHints);</span><br><span class="line">	<span class="keyword">return</span> result.getText();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完整参考示例：<a href="https://github.com/dunwu/JavaParty/blob/master/toolbox/image/src/test/java/org/zp/image/QRCodeUtilTest.java" target="_blank" rel="noopener"><u>测试例代码</u></a></p>
<p>以下是一个生成的二维码图片示例：</p>
<p><br><div align="center"><img src="http://upload-images.jianshu.io/upload_images/3101171-26b73730088f0ab8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></div><br></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://github.com/zxing/zxing" target="_blank" rel="noopener">ZXing github仓库</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/blog/page/35/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/blog/">1</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/35/">35</a><span class="page-number current">36</span><a class="page-number" href="/blog/page/37/">37</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/39/">39</a><a class="extend next" rel="next" href="/blog/page/37/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/blog/images/avatar.gif" alt="Zhang Peng">
            
              <p class="site-author-name" itemprop="name">Zhang Peng</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/blog/archives/">
              
                  <span class="site-state-item-count">381</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/blog/categories/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/blog/tags/index.html">
                  <span class="site-state-item-count">76</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/blog/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/dunwu" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:forbreak@163.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-paper-plane"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhang Peng</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/blog/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/blog/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/blog/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/blog/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/blog/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/blog/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
